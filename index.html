<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Aktionsmappe Verwaltung (Cloud Sync)</title>
    <!-- Tailwind CSS laden -->
    <script src="https://cdn.tailwindcss.com"></script>

    <!-- Firebase (Cloud-Sync fuer alle Shops) -->
    <!-- Wichtig: GitHub Pages ist statisch. "Speichern im Hosting" geht nur ueber eine Datenbank (Firestore). -->
    <script src="https://www.gstatic.com/firebasejs/10.12.5/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.12.5/firebase-firestore-compat.js"></script>
    <!-- Konfiguriere Tailwind f√ºr die Inter-Schriftart -->
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@100..900&display=swap');
        
        body {
            font-family: 'Inter', sans-serif;
            /* Dezenter, professioneller Verlauf */
            background: linear-gradient(135deg, #eff6ff 0%, #f8fafc 100%);
            background-attachment: fixed; 
            color: #1e293b; 
        }

        /* Custom Styling for the switch */
        .toggle-switch input:checked + .slider {
            background-color: #2563eb;
        }
        .toggle-switch input:checked + .slider:before {
            transform: translateX(26px);
        }

        /* Badge Animation */
        @keyframes pulse-badge {
            0% { transform: scale(1); }
            50% { transform: scale(1.1); }
            100% { transform: scale(1); }
        }
        .badge-pulse {
            animation: pulse-badge 2s infinite;
        }

        /* Helper Klassen f√ºr Druck/Screen Umschaltung */
        .print-only-text { display: none; }

        /* --- DRUCK / PDF STYLING --- */
        @media print {
            /* QUERFORMAT (Landscape) und A4 */
            @page { 
                size: A4 landscape; 
                margin: 1.0cm; 
            }
            
            /* Globale Resets f√ºr sauberen Vektor-Druck */
            * {
                -webkit-print-color-adjust: exact !important;   /* Farben drucken */
                print-color-adjust: exact !important;
                box-shadow: none !important;                    /* Keine Schatten (verhindert Rasterung) */
                text-shadow: none !important;                   /* Keine Textschatten */
                filter: none !important;                        /* Keine Filter */
            }

            body { 
                /* WICHTIG: Reinwei√ü erzwingen, damit Browser nicht rastert */
                background: #ffffff !important;
                background-image: none !important;
                
                font-size: 10pt;
                height: auto !important;
                padding-top: 5px !important;
                color: #000 !important;
            }
            
            html {
                background-color: #ffffff !important; 
                height: auto !important;
            }

            /* Elemente ausblenden */
            .no-print, 
            .screen-only-text, 
            #admin-view, 
            #status-message, 
            .toggle-switch, 
            header button, 
            header label, 
            #incentive-submit-btn,
            #submit-btn,
            #push-submit-btn,
            #bundle-submit-btn,
            .admin-controls,
            #admin-search-container,
            #user-search-container,
            #pdf-upload-section,
            #visit-counter-display,
            #data-backup-section,
            #email-update-btn,
            #single-view-back-btn { 
                display: none !important; 
            }
            
            /* Elemente einblenden */
            .print-only-text {
                display: inline-block !important;
            }

            /* --- SEITE 1: HEADER & INCENTIVES --- */

            header {
                border-bottom: 2px solid #2563eb;
                margin-bottom: 10px !important; 
                padding: 0 !important;
                text-align: center !important; 
                background: transparent !important; 
            }
            
            header .header-content {
                display: flex !important;
                align-items: center !important;
                justify-content: center !important; 
                width: 100%;
                padding-bottom: 5px;
            }

            header h1 {
                font-size: 16pt !important;
                color: #000 !important;
                margin: 0 !important;
            }
            header h1 span.screen-only-text { display: none !important; }
            
            .hetec-logo {
                background-color: transparent !important;
                color: #1d4ed8 !important;
                border: none !important;
                font-size: 14pt !important;
                margin-right: 15px !important;
            }

            /* Haupttitel "Aktionen und Incentives" */
            #user-view h2.text-3xl {
                font-size: 14pt !important;
                margin-bottom: 10px !important;
                margin-top: 0 !important;
            }

            /* Push Provisionen Liste (Seite 1) */
            #user-push-list {
                display: flex !important;
                flex-wrap: wrap;
                gap: 8px !important;
                margin-bottom: 10px !important;
                justify-content: flex-start !important; 
            }
            #user-push-list > div {
                width: 48% !important; 
                padding: 6px !important;
                border: 1px solid #999;
                background: white !important; 
                page-break-inside: avoid !important;
            }
            #user-push-list img { width: 25px !important; height: 25px !important; }
            #user-push-list h4 { font-size: 10pt !important; margin: 0 !important; }

            /* Incentives Liste (Seite 1) */
            #user-incentive-list {
                display: flex !important;
                flex-wrap: wrap;
                gap: 8px !important;
                margin-bottom: 10px !important;
                justify-content: flex-start !important; 
            }
            #user-incentive-list > div {
                width: 48% !important;
                padding: 6px !important;
                border: 1px solid #999;
                background: white !important;
                page-break-inside: avoid !important;
            }
            #user-incentive-list img { width: 35px !important; height: 35px !important; }
            #user-incentive-list h4 { font-size: 10pt !important; margin-bottom: 2px; }
            #user-incentive-list p { font-size: 9pt !important; }

            /* --- SEITE 2: GER√ÑTE-AKTIONEN & TOC --- */
            
            #device-actions-header {
                break-before: page !important;
                page-break-before: always !important;
                margin-top: 20px !important; 
                display: block !important;
                font-size: 16pt !important;
                color: #1d4ed8 !important;
                border-bottom: 2px solid #1d4ed8 !important;
                padding-bottom: 5px !important;
            }
            
            /* TOC direkt darunter auf Seite 2 */
            #toc-container {
                padding: 10px !important;
                background: white !important;
                margin-bottom: 20px !important; 
                border: 1px solid #ccc;
                border-radius: 8px;
                text-align: center !important; 
                break-before: avoid !important;
                page-break-before: avoid !important;
                width: 90% !important;
                margin-left: 5% !important;
                margin-right: 5% !important;
            }
            
            #toc-container h3 { font-size: 11pt !important; margin-bottom: 6px !important; }
            #toc-container .grid { display: flex !important; flex-wrap: wrap; gap: 5px !important; justify-content: center !important; }
            
            /* WICHTIG: Links im Druck optimieren */
            #toc-container a {
                border: 1px solid #999; 
                background: transparent !important; 
                padding: 3px 6px !important;
                font-size: 9pt !important;
                text-decoration: none !important;
                color: #000 !important;
                display: inline-block !important; 
                /* Erzwingt Text-Selektierbarkeit */
                user-select: text !important;
                -webkit-user-select: text !important;
            }

            /* BUNDLES LISTE (Seite 2 nach TOC) */
            #user-bundle-list {
                display: block !important;
                width: 100% !important;
                margin-bottom: 20px !important;
                break-before: auto !important; /* Kein harter Umbruch vor Bundles zwingend, aber oft besser */
            }
            #user-bundle-list > div {
                border: 2px solid #000;
                background: #fff !important;
                page-break-inside: avoid !important;
                margin-bottom: 10px !important;
            }

            /* --- KACHELN / INHALT (AB SEITE 3 oder nach TOC/Bundles) --- */
            
            #user-view-content {
                margin-top: 10px !important; 
            }
            
            #user-view-content .grid {
                display: block !important; 
                text-align: left !important; 
            }
            
            #user-view-content .grid > div {
                display: inline-block !important;
                width: 32% !important; 
                margin-right: 1% !important;
                margin-bottom: 15px !important;
                vertical-align: top !important;
                break-inside: avoid !important;
                page-break-inside: avoid !important;
                border: 1px solid #999 !important;
                background: white !important;
            }
            
            #user-view-content .page-break-after-3 {
                break-after: page !important;
                page-break-after: always !important;
            }

            /* Diverse Abst√§nde & Gr√∂√üen f√ºr Druck */
            .mt-10 { margin-top: 15px !important; }
            .pt-4 { padding-top: 5px !important; }
            .mb-6, .mb-12 { margin-bottom: 10px !important; }
            h3.text-3xl { 
                font-size: 13pt !important; 
                border-bottom: 1px solid #2563eb; 
                padding-bottom: 5px; 
                text-align: left !important;
                margin-top: 15px !important;
            }
            .relative.h-48 { height: 110px !important; padding: 5px !important; } 
            .p-5 { padding: 6px !important; }
            h2.text-2xl { font-size: 11pt !important; }
            .text-xs { font-size: 8pt !important; }
            .space-y-2 { margin-bottom: 3px !important; }
            
            #user-pdf-container:not(.hidden) {
                break-before: page;
                display: block !important;
            }
            #user-pdf-container.hidden { display: none !important; }
            div:empty { display: none !important; }
            
            /* Wenn Einzelansicht aktiv ist (hidden-on-single), im Druck auch ausblenden */
            .hidden-on-single { display: none !important; }
        }
    

/* === ADMIN TABS (UI-only) === */
.admin-tab-btn{background:#fff;color:#334155;border-color:#e2e8f0;}
.admin-tab-btn:hover{background:#f8fafc;}
.admin-tab-btn.is-active{background:#0f172a;color:#fff;border-color:#0f172a;}
.admin-tab-btn.is-active span{background:rgba(255,255,255,0.15);border-color:rgba(255,255,255,0.25);color:#fff;}

/* === BUNDLE CARD UI TWEAKS (Kundenansicht) === */
.bundle-card-title{font-size:18px;line-height:1.15;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;}
.bundle-card-title .bundle-title-text{display:block;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;}
@media (max-width:420px){.bundle-card-title{font-size:16px;}}
.bundle-term-select{border:1px solid rgba(255,255,255,0.35);background:rgba(255,255,255,0.12);color:#fff;padding:4px 8px;border-radius:8px;font-weight:700;font-size:12px;}
.bundle-term-select option{color:#0f172a;}
.bundle-onetime{font-size:11px;font-weight:800;color:#fee2e2;margin-top:2px;text-align:center;}


/* === SIM_IMAGE_SMALL_TWEAK === */
.bundle-images img.sim-image{
  max-width: 110px !important;
  max-height: 80px !important;
  opacity: 0.85;
  filter: saturate(0.9);
}
@media (max-width: 640px){
  .bundle-images img.sim-image{
    max-width: 90px !important;
    max-height: 65px !important;
  }
}
</style>

    
    <!-- Script f√ºr Lokale Logik -->
    <script>
        // --- KONFIGURATION & STATE ---
        const STORAGE_KEY_PROMOTIONS = 'am_promotions_data';
        const STORAGE_KEY_INCENTIVES = 'am_incentives_data';
        const STORAGE_KEY_PUSH = 'am_push_data';
        const STORAGE_KEY_BUNDLES = 'am_bundles_data'; 
        const STORAGE_KEY_VISITS = 'am_visits_data';
        const STORAGE_KEY_PDF = 'am_pdf_file_data';
        const STORAGE_KEY_CHANGES = 'am_recent_changes'; 
        
        const UPLOADED_PDF_FILE = {
            contentFetchId: "uploaded:Aktionsmappe Neu 12.2025.pdf",
            fileName: "Aktionsmappe Neu 12.2025.pdf"
        };

        let promotions = [];
        let incentives = [];
        let pushProvisions = []; 
        let bundles = []; 
        let recentChanges = [];
        let pdfData = null; 
        
        const predefinedProviders = ['o2', 'HeTec', 'GreenMnky', 'Freiertext'];

        // --- CLOUD SYNC (FIRESTORE) ---
        // Ziel: Eine gemeinsame Datenbasis fuer ALLE Shops (wie frueher), damit der Inhalt
        // auch im iFrame (Pencil Selling) auf GitHub Pages immer identisch geladen wird.
        // Hinweis: GitHub Pages kann NICHT "ins Hosting speichern". Das geht nur ueber eine DB.
        const CLOUD_SYNC_ENABLED = true;
        const CLOUD_COLLECTION = 'aktionsmappe';
        const CLOUD_DOC_ID = 'global';

        // Firebase Config (aus deiner firebase-config.json)
        const firebaseConfig = {
            apiKey: "AIzaSyCjYCn-X694K1xoUULAin_zDta1r-dSh7Y",
            authDomain: "verkaufsmappe-7d917.firebaseapp.com",
            projectId: "verkaufsmappe-7d917",
            storageBucket: "verkaufsmappe-7d917.firebasestorage.app",
            messagingSenderId: "916375365270",
            appId: "1:916375365270:web:5b6bfbc37a4d0be1a004b7"
        };

        let __firebaseApp = null;
        let __db = null;
        let __lastCloudError = null;
        let __cloudWarnedOnce = false;
        let __cloudLoadedToastShown = false;

        // FIX: Standard-SIM Bild (wird bei Bundles optional automatisch als zus√§tzliches Bild angezeigt)
        const FIXED_SIM_IMAGE_DATAURI = 'data:image/svg+xml;charset=utf-8,%3Csvg%20xmlns%3D%27http%3A//www.w3.org/2000/svg%27%20width%3D%27800%27%20height%3D%27520%27%20viewBox%3D%270%200%20800%20520%27%3E%0A%20%20%20%20%3Cdefs%3E%0A%20%20%20%20%20%20%3ClinearGradient%20id%3D%27g%27%20x1%3D%270%27%20y1%3D%270%27%20x2%3D%271%27%20y2%3D%271%27%3E%0A%20%20%20%20%20%20%20%20%3Cstop%20offset%3D%270%27%20stop-color%3D%27%23f8fafc%27/%3E%0A%20%20%20%20%20%20%20%20%3Cstop%20offset%3D%271%27%20stop-color%3D%27%23e2e8f0%27/%3E%0A%20%20%20%20%20%20%3C/linearGradient%3E%0A%20%20%20%20%3C/defs%3E%0A%20%20%20%20%3Crect%20x%3D%2730%27%20y%3D%2730%27%20rx%3D%2740%27%20ry%3D%2740%27%20width%3D%27740%27%20height%3D%27460%27%20fill%3D%27url%28%23g%29%27%20stroke%3D%27%2394a3b8%27%20stroke-width%3D%2710%27/%3E%0A%20%20%20%20%3Cpath%20d%3D%27M610%2030%20L770%20190%20L770%2030%20Z%27%20fill%3D%27%23cbd5e1%27/%3E%0A%20%20%20%20%3Crect%20x%3D%27210%27%20y%3D%27160%27%20rx%3D%2726%27%20ry%3D%2726%27%20width%3D%27380%27%20height%3D%27240%27%20fill%3D%27%23f1f5f9%27%20stroke%3D%27%2394a3b8%27%20stroke-width%3D%2710%27/%3E%0A%20%20%20%20%3Crect%20x%3D%27250%27%20y%3D%27200%27%20rx%3D%2718%27%20ry%3D%2718%27%20width%3D%27300%27%20height%3D%2780%27%20fill%3D%27%23f59e0b%27%20stroke%3D%27%23b45309%27%20stroke-width%3D%2710%27/%3E%0A%20%20%20%20%3Crect%20x%3D%27250%27%20y%3D%27305%27%20rx%3D%2718%27%20ry%3D%2718%27%20width%3D%27140%27%20height%3D%2770%27%20fill%3D%27%23fbbf24%27%20stroke%3D%27%23b45309%27%20stroke-width%3D%2710%27/%3E%0A%20%20%20%20%3Crect%20x%3D%27410%27%20y%3D%27305%27%20rx%3D%2718%27%20ry%3D%2718%27%20width%3D%27140%27%20height%3D%2770%27%20fill%3D%27%23fde68a%27%20stroke%3D%27%23b45309%27%20stroke-width%3D%2710%27/%3E%0A%20%20%20%20%3Ctext%20x%3D%2770%27%20y%3D%27470%27%20font-family%3D%27Inter%2C%20Arial%27%20font-size%3D%2752%27%20fill%3D%27%2394a3b8%27%20font-weight%3D%27700%27%3ESIM%3C/text%3E%0A%3C/svg%3E';


        function initCloudSync() {
            if (!CLOUD_SYNC_ENABLED) return false;
            try {
                if (!window.firebase || !window.firebase.initializeApp) {
                    console.warn('Firebase SDK nicht geladen. Cloud Sync deaktiviert.');
                    return false;
                }
                __firebaseApp = window.firebase.apps?.length ? window.firebase.app() : window.firebase.initializeApp(firebaseConfig);
                __db = window.firebase.firestore();
                return true;
            } catch (e) {
                console.warn('Cloud Sync init fehlgeschlagen:', e);
                return false;
            }
        }

        async function loadDataFromCloud() {
            if (!initCloudSync() || !__db) return null;
            try {
                const ref = __db.collection(CLOUD_COLLECTION).doc(CLOUD_DOC_ID);
                const snap = await ref.get();
                if (!snap.exists) return null;
                const data = snap.data() || null;
                return data;
            } catch (e) {
                __lastCloudError = e;
                const msg = (e && (e.code || e.message)) ? ((e.code ? (e.code + ": ") : "") + (e.message || "")) : "Unbekannter Fehler";
                console.warn('Cloud Load fehlgeschlagen:', e);
                if (!__cloudWarnedOnce) {
                    __cloudWarnedOnce = true;
                    try { showMessage("‚ö†Ô∏è Cloud-Load fehlgeschlagen: " + msg, true); } catch(_) {}
                }
                return null;
            }
        }

        async function saveDataToCloud(payload) {
            if (!initCloudSync() || !__db) return false;
            try {
                const ref = __db.collection(CLOUD_COLLECTION).doc(CLOUD_DOC_ID);
                // Merge: falls du spaeter Felder erweiterst, bleibt es kompatibel
                await ref.set({
                    ...payload,
                    __meta: {
                        updatedAt: new Date().toISOString(),
                        app: 'Verkaufsmappe',
                        version: 'cloud-sync-v1'
                    }
                }, { merge: true });
                return true;
            } catch (e) {
                __lastCloudError = e;
                const msg = (e && (e.code || e.message)) ? ((e.code ? (e.code + ": ") : "") + (e.message || "")) : "Unbekannter Fehler";
                console.warn('Cloud Save fehlgeschlagen:', e);
                return false;
            }
        }

        // --- FIXED BUNDLE SLOTS (3 pro Canvas) ---
        // Regel: Bundle-Slots werden NICHT geloescht, nur aktiviert/deaktiviert.
        const BUNDLE_CANVAS_CATEGORIES = [
            { key: 'canvas1', label: '1. Hardware, Anbieter & Nutzung' },
            { key: 'canvas2', label: '2. Haushalt und weitere Produkte' },
            { key: 'canvas3', label: '3. Fernsehen & Wi-Fi' },
        ];

        const FIXED_BUNDLE_SLOTS = [
            { id: 'hw-01', categoryKey: 'canvas1', label: 'Canvas 1 - Angebot 1' },
            { id: 'hw-02', categoryKey: 'canvas1', label: 'Canvas 1 - Angebot 2' },
            { id: 'hw-03', categoryKey: 'canvas1', label: 'Canvas 1 - Angebot 3' },
            { id: 'home-01', categoryKey: 'canvas2', label: 'Canvas 2 - Angebot 1' },
            { id: 'home-02', categoryKey: 'canvas2', label: 'Canvas 2 - Angebot 2' },
            { id: 'home-03', categoryKey: 'canvas2', label: 'Canvas 2 - Angebot 3' },
            { id: 'tv-01', categoryKey: 'canvas3', label: 'Canvas 3 - Angebot 1' },
            { id: 'tv-02', categoryKey: 'canvas3', label: 'Canvas 3 - Angebot 2' },
            { id: 'tv-03', categoryKey: 'canvas3', label: 'Canvas 3 - Angebot 3' },
        ];

        function __getCategoryLabel(key) {
            return (BUNDLE_CANVAS_CATEGORIES.find(c => c.key === key) || {}).label || key || '';
        }

        function __getSlotMeta(id) {
            return FIXED_BUNDLE_SLOTS.find(s => s.id === id) || null;
        }

        function __bundleOrderIndex(id) {
            const idx = FIXED_BUNDLE_SLOTS.findIndex(s => s.id === id);
            return idx === -1 ? 9999 : idx;
        }

        function sortBundlesForUI(list) {
            return [...(list || [])].sort((a, b) => __bundleOrderIndex(a.id) - __bundleOrderIndex(b.id));
        }

        function ensureFixedBundleSlots() {
            const fixedIds = new Set(FIXED_BUNDLE_SLOTS.map(s => s.id));
            const map = new Map((bundles || []).map(b => [b.id, b]));

            const fixed = [];
            for (const slot of FIXED_BUNDLE_SLOTS) {
                const existing = map.get(slot.id);
                if (existing) {
                    existing.__fixedSlot = true;
                    existing.legacy = false;
                    existing.categoryKey = slot.categoryKey;
                    existing.categoryLabel = __getCategoryLabel(slot.categoryKey);
                    if (typeof existing.active !== 'boolean') existing.active = true;
                    if (!Array.isArray(existing.images)) existing.images = [];
                    fixed.push(existing);
                } else {
                    fixed.push({
                        id: slot.id,
                        __fixedSlot: true,
                        legacy: false,
                        categoryKey: slot.categoryKey,
                        categoryLabel: __getCategoryLabel(slot.categoryKey),
                        active: false,
                        titel: '',
                        tarifName: '',
                        angebotspreis: '',
                        optionOnlineSchutz: false,
                        optionTV: false,
                        optionCustom: '',
                        hasSim: true,
                        images: [],
                        shopLink: '',
                        gutscheincode: '',
                        rechnungsweg: '',
                        start: '',
                        end: '',
                        createdAt: new Date().toISOString()
                    });
                }
            }

            const legacy = (bundles || []).filter(b => !fixedIds.has(b.id)).map(b => ({
                ...b,
                legacy: true,
                __fixedSlot: false,
                active: false,
                categoryKey: b.categoryKey || 'legacy',
                categoryLabel: b.categoryLabel || 'Legacy'
            }));

            bundles = [...fixed, ...legacy];
        }

        function populateBundleSlotOptions() {
            const sel = document.getElementById('bundleSlot');
            if (!sel) return;
            sel.innerHTML = '';

            for (const cat of BUNDLE_CANVAS_CATEGORIES) {
                const og = document.createElement('optgroup');
                og.label = cat.label;
                FIXED_BUNDLE_SLOTS.filter(s => s.categoryKey === cat.key).forEach(s => {
                    const opt = document.createElement('option');
                    opt.value = s.id;
                    opt.textContent = `${s.label} (ID: ${s.id})`;
                    og.appendChild(opt);
                });
                sel.appendChild(og);
            }
        }
        // --- /FIXED BUNDLE SLOTS ---


        const generateId = () => {
            return Date.now().toString(36) + Math.random().toString(36).substr(2);
        };

        // --- DATEN LADE/SPEICHER LOGIK ---

        async function loadData() {
            try {
                // 1) Zuerst versuchen wir die gemeinsame Cloud-Datenbasis zu laden.
                //    Wenn vorhanden: in State uebernehmen UND als Cache in localStorage spiegeln.
                const cloud = await loadDataFromCloud();
                if (cloud && typeof cloud === 'object') {
                    try {
                        if (Array.isArray(cloud.promotions)) {
                            promotions = cloud.promotions;
                            localStorage.setItem(STORAGE_KEY_PROMOTIONS, JSON.stringify(promotions));
                        }
                        if (Array.isArray(cloud.incentives)) {
                            incentives = cloud.incentives;
                            localStorage.setItem(STORAGE_KEY_INCENTIVES, JSON.stringify(incentives));
                        }
                        if (Array.isArray(cloud.pushProvisions)) {
                            pushProvisions = cloud.pushProvisions;
                            localStorage.setItem(STORAGE_KEY_PUSH, JSON.stringify(pushProvisions));
                        }
                        if (Array.isArray(cloud.bundles)) {
                            bundles = cloud.bundles;
                            localStorage.setItem(STORAGE_KEY_BUNDLES, JSON.stringify(bundles));
                        }
                        if (!__cloudLoadedToastShown) { __cloudLoadedToastShown = true; showMessage("‚úÖ Cloud-Daten geladen (alle Shops)"); }
                    } catch (e) {
                        console.warn('Cloud->Local Cache fehlgeschlagen:', e);
                    }
                }

                const pData = localStorage.getItem(STORAGE_KEY_PROMOTIONS);
                const iData = localStorage.getItem(STORAGE_KEY_INCENTIVES);
                const pushData = localStorage.getItem(STORAGE_KEY_PUSH);
                const bundleData = localStorage.getItem(STORAGE_KEY_BUNDLES);
                let pdfLocal = localStorage.getItem(STORAGE_KEY_PDF);
                const changesData = localStorage.getItem(STORAGE_KEY_CHANGES);

                if (!pdfLocal) {
                    try {
                        const response = await fetch(`data/${UPLOADED_PDF_FILE.contentFetchId}`);
                        if (response.ok) {
                            const blob = await response.blob();
                            const base64 = await new Promise((resolve) => {
                                const reader = new FileReader();
                                reader.onloadend = () => resolve(reader.result);
                                reader.readAsDataURL(blob);
                            });
                            const newPdfData = {
                                name: UPLOADED_PDF_FILE.fileName,
                                data: base64,
                                date: new Date().toLocaleDateString()
                            };
                            localStorage.setItem(STORAGE_KEY_PDF, JSON.stringify(newPdfData));
                            pdfLocal = JSON.stringify(newPdfData);
                            showMessage("Hochgeladene PDF-Datei automatisch geladen.");
                        }
                    } catch (e) {
                        console.warn("Konnte hochgeladene PDF nicht automatisch laden.", e);
                    }
                }
                
                // 2) Wenn Cloud nicht geladen werden konnte, nehmen wir localStorage.
                //    (Oder: Cloud hat keine Daten -> localStorage fallback)
                promotions = (promotions && promotions.length) ? promotions : (pData ? JSON.parse(pData) : []);
                incentives = (incentives && incentives.length) ? incentives : (iData ? JSON.parse(iData) : []);
                bundles = (bundles && bundles.length) ? bundles : (bundleData ? JSON.parse(bundleData) : []);
                ensureFixedBundleSlots();
                recentChanges = changesData ? JSON.parse(changesData) : [];
                
                pushProvisions = (pushProvisions && pushProvisions.length)
                    ? pushProvisions.map(p => {
                        // normalize
                        if (!p.betrag && typeof p.titel === 'string' && p.titel.includes('‚Ç¨')) {
                            const numericPart = parseFloat(p.titel.replace('‚Ç¨', '').trim());
                            return {
                                ...p,
                                titel: 'Zusatz-Push',
                                betrag: isNaN(numericPart) ? 0 : numericPart,
                            };
                        }
                        p.betrag = p.betrag ? parseFloat(p.betrag) : 0;
                        return p;
                    })
                    : (pushData ? JSON.parse(pushData).map(p => {
                    if (!p.betrag && typeof p.titel === 'string' && p.titel.includes('‚Ç¨')) {
                        const numericPart = parseFloat(p.titel.replace('‚Ç¨', '').trim());
                        return {
                            ...p,
                            titel: 'Zusatz-Push',
                            betrag: isNaN(numericPart) ? 0 : numericPart,
                        };
                    }
                    p.betrag = p.betrag ? parseFloat(p.betrag) : 0;
                    return p;
                }) : []);
                pdfData = pdfLocal ? JSON.parse(pdfLocal) : null;
                
                promotions.sort((a, b) => new Date(b.createdAt) - new Date(a.createdAt));
                incentives.sort((a, b) => new Date(b.createdAt) - new Date(a.createdAt));
                pushProvisions.sort((a, b) => new Date(b.createdAt) - new Date(a.createdAt));
                bundles = sortBundlesForUI(bundles);

                // CHECK FOR BUNDLE ID IN URL (DEEP LINKING)
                const urlParams = new URLSearchParams(window.location.search);
                const bundleId = urlParams.get('bundleId');
                
                if(bundleId) {
                    // Activate Single View Mode
                    renderSingleBundleView(bundleId);
                } else {
                    refreshUI();
                }

            } catch (e) {
                console.error("Fehler beim Laden der lokalen Daten", e);
                showMessage("Fehler beim Laden der Daten", true);
            }
        }


        // Re-render ohne Cloud-Load (verhindert Storage-Event Ping-Pong zwischen mehreren Tabs)
        function reloadFromLocalStorageOnly() {
            try {
                const pData = localStorage.getItem(STORAGE_KEY_PROMOTIONS);
                const iData = localStorage.getItem(STORAGE_KEY_INCENTIVES);
                const pushData = localStorage.getItem(STORAGE_KEY_PUSH);
                const bundleData = localStorage.getItem(STORAGE_KEY_BUNDLES);
                const pdfLocal = localStorage.getItem(STORAGE_KEY_PDF);
                const changesData = localStorage.getItem(STORAGE_KEY_CHANGES);

                promotions = pData ? JSON.parse(pData) : (promotions || []);
                incentives = iData ? JSON.parse(iData) : (incentives || []);
                bundles = bundleData ? JSON.parse(bundleData) : (bundles || []);
                ensureFixedBundleSlots();
                recentChanges = changesData ? JSON.parse(changesData) : (recentChanges || []);

                const normalizePush = (p) => {
                    // normalize legacy format
                    if (!p.betrag && typeof p.titel === 'string' && p.titel.includes('‚Ç¨')) {
                        const numericPart = parseFloat(p.titel.replace('‚Ç¨', '').trim());
                        return {
                            ...p,
                            titel: 'Zusatz-Push',
                            betrag: isNaN(numericPart) ? 0 : numericPart,
                        };
                    }
                    p.betrag = p.betrag ? parseFloat(p.betrag) : 0;
                    return p;
                };

                pushProvisions = pushData ? JSON.parse(pushData).map(normalizePush) : (pushProvisions || []);
                pdfData = pdfLocal ? JSON.parse(pdfLocal) : (pdfData || null);

                promotions.sort((a, b) => new Date(b.createdAt) - new Date(a.createdAt));
                incentives.sort((a, b) => new Date(b.createdAt) - new Date(a.createdAt));
                pushProvisions.sort((a, b) => new Date(b.createdAt) - new Date(a.createdAt));
                bundles = sortBundlesForUI(bundles);

                const urlParams = new URLSearchParams(window.location.search);
                const bundleId = urlParams.get('bundleId');
                if (bundleId) {
                    renderSingleBundleView(bundleId);
                } else {
                    refreshUI();
                }
            } catch (e) {
                console.warn('Local reload fehlgeschlagen:', e);
            }
        }

        function saveData() {
            try {
                localStorage.setItem(STORAGE_KEY_PROMOTIONS, JSON.stringify(promotions));
                localStorage.setItem(STORAGE_KEY_INCENTIVES, JSON.stringify(incentives));
                localStorage.setItem(STORAGE_KEY_PUSH, JSON.stringify(pushProvisions));
                localStorage.setItem(STORAGE_KEY_BUNDLES, JSON.stringify(bundles));

                // Cloud Sync: zentrale Speicherung fuer alle Shops
                // (ohne PDF Base64, um Firestore-Dokumentgroesse nicht zu sprengen)
                if (CLOUD_SYNC_ENABLED) {
                    // nicht blockieren, aber Feedback geben
                    (async () => {
                        const ok = await saveDataToCloud({
                            promotions,
                            incentives,
                            pushProvisions,
                            bundles
                        });
                        if (ok) {
                            showMessage("‚úÖ In Cloud gespeichert (alle Shops)");
                        } else {
                            const err = (__lastCloudError && (__lastCloudError.code || __lastCloudError.message)) ? (((__lastCloudError.code ? (__lastCloudError.code + ": ") : "") ) + (__lastCloudError.message || "")) : "Bitte Konsole pr√ºfen";
                            showMessage("‚ö†Ô∏è Cloud-Speichern fehlgeschlagen: " + err, true);
                        }
                    })();
                }
                refreshUI();
            } catch (e) {
                console.error("Fehler beim Speichern", e);
                showMessage("Speicherfehler (Speicher voll?)", true);
            }
        }

        // --- UPDATE / EMAIL LOGIK ---

        function addRecentChange(text) {
            recentChanges.push(text);
            localStorage.setItem(STORAGE_KEY_CHANGES, JSON.stringify(recentChanges));
            refreshUI(); 
        }

        function sendUpdateEmail() {
            if (recentChanges.length === 0) {
                showMessage("Keine gespeicherten √Ñnderungen zum Versenden.", true);
                return;
            }
            const subject = encodeURIComponent("News in der Aktionsmappe");
            const bodyContent = "Hallo Zusammen,\n\nhier sind die neuesten Updates aus der Aktionsmappe:\n\n" + 
                                recentChanges.map(c => "- " + c).join("\n") + 
                                "\n\nBitte pr√ºft die aktuelle Mappe f√ºr Details.\n\nViele Gr√º√üe";
            const body = encodeURIComponent(bodyContent);
            window.location.href = `mailto:?subject=${subject}&body=${body}`;
            setTimeout(() => {
                if(confirm("Hat sich das E-Mail Fenster ge√∂ffnet? Sollen die √Ñnderungen nun aus der Liste 'ungesendet' entfernt werden?")) {
                    recentChanges = [];
                    localStorage.removeItem(STORAGE_KEY_CHANGES);
                    refreshUI();
                    showMessage("√Ñnderungsliste zur√ºckgesetzt.");
                }
            }, 1000);
        }

        function updateEmailButtonBadge() {
            const badge = document.getElementById('email-badge');
            if (recentChanges.length > 0) {
                badge.textContent = recentChanges.length;
                badge.classList.remove('hidden');
                badge.classList.add('badge-pulse');
            } else {
                badge.classList.add('hidden');
                badge.classList.remove('badge-pulse');
            }
        }

        function refreshUI() {
            if (typeof filterAdminPromotions === 'function') filterAdminPromotions(); 
            if (typeof renderAdminIncentiveList === 'function') renderAdminIncentiveList(incentives);
            if (typeof renderAdminPushList === 'function') renderAdminPushList(pushProvisions); 
            if (typeof renderAdminBundleList === 'function') renderAdminBundleList(bundles); 
            
            const userSearchInput = document.getElementById('user-search');
            if (userSearchInput && userSearchInput.value) {
                if (typeof handleUserSearch === 'function') handleUserSearch(); 
            } else {
                if (typeof renderUserView === 'function') renderUserView(promotions, incentives, pushProvisions, bundles);
            }

            if (typeof renderPdfView === 'function') renderPdfView(); 
            updateEmailButtonBadge();
        }

        // --- SINGLE BUNDLE LINKING LOGIC (NEU) ---
        function renderSingleBundleView(bundleId) {
            // Ensure User view is active, Admin hidden
            document.getElementById('admin-view').classList.add('hidden');
            document.getElementById('user-view').classList.remove('hidden');
            document.getElementById('view-toggle').checked = false;
            document.getElementById('view-name').textContent = 'Einzelansicht';
            
            // Hide standard User View elements (using a class helper logic)
            document.getElementById('toc-container').classList.add('hidden-on-single', 'hidden');
            document.getElementById('user-push-list').parentElement.classList.add('hidden-on-single', 'hidden');
            document.getElementById('user-incentive-list').parentElement.classList.add('hidden-on-single', 'hidden');
            document.getElementById('device-actions-header').classList.add('hidden-on-single', 'hidden');
            document.getElementById('user-view-content').classList.add('hidden-on-single', 'hidden');
            document.getElementById('user-pdf-container').classList.add('hidden-on-single', 'hidden');
            
            // Header controls adjustments for single view
            document.querySelector('.toggle-switch').style.display = 'none'; // Hide Admin switch
            document.getElementById('user-search-container').style.display = 'none'; // Hide Search

            // Find Bundle
            const bundle = bundles.find(b => b.id === bundleId);
            const bundleListEl = document.getElementById('user-bundle-list');
            const bundleHeaderEl = document.getElementById('bundle-section-header');
            
            // Show Back Button
            const backBtn = document.createElement('button');
            backBtn.id = 'single-view-back-btn';
            backBtn.textContent = '‚Üê Zur√ºck zur √úbersicht';
            backBtn.className = 'mb-6 px-4 py-2 bg-gray-600 text-white rounded hover:bg-gray-700 transition font-semibold';
            backBtn.onclick = () => {
                // Remove ID from URL without reload
                const url = new URL(window.location);
                url.searchParams.delete('bundleId');
                window.history.pushState({}, '', url);
                window.location.reload(); // Reload to restore full state cleanly
            };
            
            // Insert Back Button before Title
            const titleContainer = document.querySelector('#user-view h2').parentElement;
            titleContainer.insertBefore(backBtn, titleContainer.firstChild);

            if (bundle) {
                window.__ACTIVE_BUNDLE_FOR_TRANSFER = bundle;
                // Render ONLY this bundle.
                 // Optional: wenn im PencilSelling-iFrame ge√∂ffnet, einmal automatisch senden
                 setTimeout(() => { try { if (window.parent && window.parent !== window) sendBundleDataToParent(bundle); } catch(_) {} }, 800);
                 renderUserView([], [], [], [bundle], true); 
                 bundleListEl.classList.remove('hidden');
                 bundleHeaderEl.classList.remove('hidden');
                 bundleHeaderEl.querySelector('h3').textContent = "Ihre Auswahl:";
            } else {
                bundleListEl.innerHTML = '<div class="p-8 bg-red-100 text-red-700 rounded-lg text-center font-bold">Angebot nicht gefunden oder abgelaufen.</div>';
                bundleListEl.classList.remove('hidden');
            }
        }

        // --- BUNDLE -> PENCILSELLING AUTO-IMPORT (postMessage) ---
        // Speichert das aktuell ge√∂ffnete Bundle (Einzelansicht) f√ºr den Import ins PencilSelling-Dashboard.
        window.__ACTIVE_BUNDLE_FOR_TRANSFER = window.__ACTIVE_BUNDLE_FOR_TRANSFER || null;

        function __normalizeEuro(val) {
            const s = String(val ?? '').trim();
            if (!s) return '';
            // akzeptiert "89,99", "89.99", "89,99 ‚Ç¨"
            if (s.includes('‚Ç¨')) return s;
            return s + ' ‚Ç¨';
        }

        function __buildDetailsHTMLFromText(text) {
            const raw = String(text ?? '').replace(/\r/g, '').trim();
            if (!raw) return '';
            const lines = raw.split('\n').map(l => l.trim()).filter(Boolean);
            // Wenn schon Bullet-Style drin ist, √ºbernehmen wir es als Liste.
            const items = [];
            for (const l of lines) {
                const cleaned = l.replace(/^[-‚Ä¢]\s*/, '').trim();
                if (!cleaned) continue;
                items.push(cleaned);
            }
            if (!items.length) return '';
            return `
                <ul style="margin:0; padding-left:18px;">
                    ${items.map(i => `<li style="margin:6px 0;">${i.replace(/</g,'&lt;').replace(/>/g,'&gt;')}</li>`).join('')}
                </ul>
            `;
        }

        function __extractBadgesFromBundle(b) {
            const badges = [];
            if (!b) return badges;
            if (b.optionOnlineSchutz) badges.push('inkl. online Schutz');
            if (b.optionTV) badges.push('o2 TV');
            const custom = String(b.optionCustom ?? '').trim();
            if (custom) badges.push(custom);
            // Ein paar h√§ufige Keywords aus dem Rechnungsweg als Badge √ºbernehmen
            const rw = String(b.rechnungsweg ?? '').toLowerCase();
            if (rw.includes('online to offline')) badges.push('online to offline');
            return badges.slice(0, 6);
        }

        function sendBundleDataToParent(bundle) {
            const b = bundle || window.__ACTIVE_BUNDLE_FOR_TRANSFER;
            if (!b) return;

            const images = Array.isArray(b.images) ? b.images.filter(Boolean).slice(0, 2) : [];
            const badges = __extractBadgesFromBundle(b);
            const detailsHTML = __buildDetailsHTMLFromText(b.rechnungsweg || '');

            const payload = {
                type: 'BUNDLE_DATA_TRANSFER',
                titel: b.titel || 'Bundle',
                tarifName: b.tarifName || '',
                preis: __normalizeEuro(b.angebotspreis || ''),
                detailsHTML: detailsHTML,
                badges: badges,
                validUntil: b.end || '',
                images: images,

                // Extra-Compat (PencilSelling Render-Logik: geraet/tarif/preis/bild)
                isBundle: true,
                geraet: b.titel || 'Bundle',
                tarif: b.tarifName || '',
                angebotspreis: b.angebotspreis || '',
                bild: images[0] || '',

                // Backward-Compat
                bezeichnung: b.titel || 'Bundle',
                artikelName: b.tarifName || '',
                bildUrl: images[0] || ''
            };

            // Nur senden, wenn wir wirklich in einem iFrame / Parent-Kontext sind
            if (window.parent && window.parent !== window) {
                window.parent.postMessage(payload, '*');
                console.log('[Aktionsmappe] BUNDLE_DATA_TRANSFER gesendet:', payload);
            }
        }

        // Empf√§ngt Anfrage vom PencilSelling (BundleModal) und antwortet mit BUNDLE_DATA_TRANSFER.
        window.addEventListener('message', (e) => {
            const d = e.data || {};
            if (d && d.type === 'REQUEST_BUNDLE_SCREENSHOT') {
                // Wir senden bewusst Daten (HTML) statt Screenshot.
                sendBundleDataToParent();
            }
        });
        // --- /BUNDLE -> PENCILSELLING AUTO-IMPORT ---

        window.copyBundleLink = (id) => {
            const baseUrl = window.location.href.split('?')[0];
            const link = `${baseUrl}?bundleId=${id}`;
            navigator.clipboard.writeText(link).then(() => {
                showMessage("üîó Direkt-Link in Zwischenablage kopiert!");
            }, (err) => {
                console.error('Copy failed', err);
                prompt("Kopieren fehlgeschlagen. Hier ist der Link:", link);
            });
        };

        // --- PDF LOGIK ---
        // (Unver√§ndert)
        window.handlePdfUpload = (event) => {
            const file = event.target.files[0];
            if (!file) return;
            if (file.type !== 'application/pdf') {
                showMessage("Bitte nur PDF-Dateien ausw√§hlen!", true);
                return;
            }
            if (file.size > 5 * 1024 * 1024) {
                if(!confirm("Die Datei ist gr√∂√üer als 5MB. Das Speichern im Browser k√∂nnte fehlschlagen. Trotzdem versuchen?")) return;
            }
            const reader = new FileReader();
            reader.onload = function(e) {
                const base64 = e.target.result;
                const newPdfData = { name: file.name, data: base64, date: new Date().toLocaleDateString() };
                try {
                    localStorage.setItem(STORAGE_KEY_PDF, JSON.stringify(newPdfData));
                    pdfData = newPdfData;
                    renderPdfView();
                    showMessage("PDF erfolgreich gespeichert!");
                } catch (err) {
                    console.error(err);
                    showMessage("Fehler: PDF zu gro√ü f√ºr den lokalen Speicher!", true);
                }
            };
            reader.readAsDataURL(file);
        };

        window.deletePdf = () => {
            if(!confirm("M√∂chten Sie das gespeicherte PDF wirklich l√∂schen?")) return;
            localStorage.removeItem(STORAGE_KEY_PDF);
            pdfData = null;
            renderPdfView();
            document.getElementById('pdf-upload-input').value = '';
            showMessage("PDF gel√∂scht.");
        };

        function renderPdfView() {
            const containerUser = document.getElementById('user-pdf-container');
            const containerAdmin = document.getElementById('admin-pdf-preview');
            const statusLabel = document.getElementById('pdf-status-label');

            if (!pdfData) {
                const noPdfHtml = '<p class="text-gray-400 italic">Keine PDF-√úbersicht hinterlegt.</p>';
                if(containerUser) { containerUser.innerHTML = ''; containerUser.classList.add('hidden'); }
                if(containerAdmin) containerAdmin.innerHTML = noPdfHtml;
                if(statusLabel) statusLabel.textContent = "Kein PDF ausgew√§hlt";
                return;
            }
            if(statusLabel) statusLabel.textContent = `Aktuelles PDF: ${pdfData.name} (vom ${pdfData.date})`;
            const embedHtml = `
                <div class="mt-4 border-t-4 border-gray-800 bg-white rounded-xl shadow-lg p-4 break-before-page">
                    <div class="flex justify-between items-center mb-4">
                        <h3 class="text-xl font-bold text-gray-800">üìÑ Aktions√ºbersicht (PDF)</h3>
                        <span class="text-xs text-gray-500">${pdfData.name}</span>
                    </div>
                    <object data="${pdfData.data}" type="application/pdf" width="100%" height="800px" class="rounded border border-gray-200">
                        <p>Ihr Browser kann dieses PDF nicht direkt anzeigen. <a href="${pdfData.data}" download="${pdfData.name}" class="text-blue-600 underline">Hier klicken zum Download</a>.</p>
                    </object>
                </div>
            `;
            if(containerUser) { containerUser.innerHTML = embedHtml; containerUser.classList.remove('hidden'); }
            if(containerAdmin) containerAdmin.innerHTML = embedHtml;
        }

        // --- FILTER FUNKTIONEN (ADMIN & USER) ---
        function filterAdminPromotions() {
            const searchInput = document.getElementById('admin-search');
            const searchTerm = searchInput ? searchInput.value.toLowerCase() : '';
            let filteredList = promotions;
            if (searchTerm) {
                filteredList = promotions.filter(p => 
                    (p.geraetebezeichnung && p.geraetebezeichnung.toLowerCase().includes(searchTerm)) ||
                    (p.anbieter && p.anbieter.toLowerCase().includes(searchTerm))
                );
            }
            renderAdminPromotionList(filteredList);
        }

        function handleUserSearch() {
            const searchInput = document.getElementById('user-search');
            const searchTerm = searchInput ? searchInput.value.toLowerCase() : '';

            if (!searchTerm) {
                renderUserView(promotions, incentives, pushProvisions, bundles);
                return;
            }

            const filteredPromotions = promotions.filter(p => 
                (p.geraetebezeichnung && p.geraetebezeichnung.toLowerCase().includes(searchTerm)) ||
                (p.anbieter && p.anbieter.toLowerCase().includes(searchTerm)) ||
                (p.bemerkung && p.bemerkung.toLowerCase().includes(searchTerm))
            );
            const filteredIncentives = incentives.filter(i => 
                (i.titel && i.titel.toLowerCase().includes(searchTerm)) ||
                (i.bemerkung && i.bemerkung.toLowerCase().includes(searchTerm))
            );
            const filteredPush = pushProvisions.filter(p => 
                (p.titel && p.titel.toLowerCase().includes(searchTerm)) ||
                (p.bemerkung && p.bemerkung.toLowerCase().includes(searchTerm))
            );
            const filteredBundles = bundles.filter(b =>
                (b.titel && b.titel.toLowerCase().includes(searchTerm)) ||
                (b.rechnungsweg && b.rechnungsweg.toLowerCase().includes(searchTerm))
            );

            renderUserView(filteredPromotions, filteredIncentives, filteredPush, filteredBundles);
        }

        // --- BESUCHER TRACKING ---
        const trackAndDisplayVisits = () => {
            const today = new Date();
            const currentMonthYear = `${today.getFullYear()}-${today.getMonth() + 1}`;
            let visitsData = { count: 0, monthYear: currentMonthYear };
            const storedVisits = localStorage.getItem(STORAGE_KEY_VISITS);
            if (storedVisits) {
                try {
                    const parsed = JSON.parse(storedVisits);
                    if (parsed.monthYear === currentMonthYear) { visitsData = parsed; } 
                    else { visitsData.monthYear = currentMonthYear; visitsData.count = 0; }
                } catch(e) {}
            }
            visitsData.count++;
            localStorage.setItem(STORAGE_KEY_VISITS, JSON.stringify(visitsData));
            document.getElementById('visit-counter-display').textContent = `Besuche diesen Monat: ${visitsData.count}`;
        };

        // --- HELPER FUNKTIONEN ---
        const calculateMargin = (einkauf, verkauf, noEK, noVK) => {
            if (noEK || noVK) return null; 
            const e = parseFloat(einkauf);
            const v = parseFloat(verkauf);
            if (isNaN(e) || isNaN(v)) return 'N/A';
            return ((v / 1.19) - e).toFixed(2);
        };

        const showMessage = (message, isError = false) => {
            const msgEl = document.getElementById('status-message');
            msgEl.textContent = message;
            msgEl.className = `p-3 mb-4 rounded-lg text-white ${isError ? 'bg-red-500' : 'bg-green-500'}`;
            msgEl.classList.remove('hidden');
            setTimeout(() => msgEl.classList.add('hidden'), 3000);
        };

        const isExpired = (endDateStr) => {
            if (!endDateStr) return true; 
            const today = new Date();
            today.setHours(0, 0, 0, 0);
            const [year, month, day] = endDateStr.split('-').map(Number);
            const endDate = new Date(Date.UTC(year, month - 1, day));
            return endDate < today;
        };

        const formatCurrencyInput = (input) => {
            let val = input.value.trim();
            if (!val || val.includes('‚Ç¨')) return;
            if (/\d/.test(val)) {
                input.value = val + ' ‚Ç¨';
            }
        };

        window.exportToPdf = () => {
            setTimeout(() => {
                window.print();
            }, 100);
        };

        window.togglePriceInput = (type, isChecked) => {
            const input = document.getElementById(type === 'EK' ? 'einkaufspreis' : 'verkaufspreis');
            if (isChecked) {
                input.value = '';
                input.disabled = true;
                input.classList.add('bg-gray-100');
            } else {
                input.disabled = false;
                input.classList.remove('bg-gray-100');
            }
            const eEl = document.getElementById('einkaufspreis');
            const vEl = document.getElementById('verkaufspreis');
            const margePreviewEl = document.getElementById('marge-preview');
            if (eEl.disabled || vEl.disabled) {
                margePreviewEl.textContent = 'Marge: -';
                margePreviewEl.className = 'text-gray-400 font-semibold text-lg';
            } else {
                const e = parseFloat(eEl.value);
                const v = parseFloat(vEl.value);
                if (!isNaN(e) && !isNaN(v)) {
                    const m = ((v / 1.19) - e);
                    margePreviewEl.textContent = `Vorschau Marge (Netto): ${m.toFixed(2)} ‚Ç¨`;
                    margePreviewEl.className = `font-semibold ${m >= 0 ? 'text-green-600' : 'text-red-600'}`;
                } else {
                    margePreviewEl.textContent = '';
                }
            }
        };

        // --- BACKUP LOGIK ---
        window.exportData = () => {
            const dataToExport = {
                promotions: promotions,
                incentives: incentives,
                pushProvisions: pushProvisions,
                bundles: bundles 
            };
            const jsonString = JSON.stringify(dataToExport, null, 2);
            const blob = new Blob([jsonString], { type: "application/json" });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `aktionsmappe_backup_${new Date().toISOString().slice(0, 10)}.json`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
            showMessage("Daten erfolgreich als JSON exportiert.");
        };

        window.importData = (event) => {
            const file = event.target.files[0];
            if (!file) return;

            if (file.type !== 'application/json' && !file.name.endsWith('.json')) {
                showMessage("Bitte w√§hlen Sie eine g√ºltige JSON-Backup-Datei.", true);
                return;
            }

            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const parsedData = JSON.parse(e.target.result);
                    if (!parsedData.promotions || !parsedData.incentives) {
                         showMessage("Fehler: Die JSON-Datei hat nicht die erwartete Struktur.", true);
                         return;
                    }
                    localStorage.setItem(STORAGE_KEY_PROMOTIONS, JSON.stringify(parsedData.promotions));
                    localStorage.setItem(STORAGE_KEY_INCENTIVES, JSON.stringify(parsedData.incentives));
                    localStorage.setItem(STORAGE_KEY_PUSH, JSON.stringify(parsedData.pushProvisions || []));
                    localStorage.setItem(STORAGE_KEY_BUNDLES, JSON.stringify(parsedData.bundles || [])); 
                    loadData();
                    showMessage(`Daten von Backup-Datei erfolgreich wiederhergestellt!`);
                } catch (err) {
                    console.error("Import Fehler:", err);
                    showMessage("Fehler beim Parsen der JSON-Datei. Ist sie besch√§digt?", true);
                }
            };
            reader.readAsText(file);
        };


        // --- CRUD ACTIONS (BUNDLES) ---
        
        window.addBundleImageField = (value = '') => {
            const container = document.getElementById('bundle-images-container');
            const wrapper = document.createElement('div');
            wrapper.className = 'flex gap-2 items-center';
            const input = document.createElement('input');
            input.type = 'url';
            input.value = value;
            input.placeholder = 'https://beispiel.de/bild.jpg';
            input.className = 'block w-full rounded-md border-gray-300 shadow-sm p-2 border flex-grow';
            const removeBtn = document.createElement('button');
            removeBtn.type = 'button';
            removeBtn.innerHTML = 'üóëÔ∏è';
            removeBtn.className = 'bg-red-100 text-red-600 px-3 py-2 rounded hover:bg-red-200 transition';
            removeBtn.onclick = () => wrapper.remove();
            wrapper.appendChild(input);
            wrapper.appendChild(removeBtn);
            container.appendChild(wrapper);
        };

        window.saveBundle = (event) => {
            event.preventDefault();
            const form = event.target;

            const slotId = (form.bundleSlot && form.bundleSlot.value) ? form.bundleSlot.value : '';
            const meta = __getSlotMeta(slotId);
            if (!meta) {
                showMessage('Bitte einen gueltigen Bundle-Slot auswaehlen.', true);
                return;
            }

            const imageInputs = document.querySelectorAll('#bundle-images-container input');
            const imagesArray = Array.from(imageInputs).map(input => input.value.trim()).filter(url => url.length > 0);

            const preis24 = String(form.bundlePreis24?.value || form.bundlePreis?.value || '').trim();
            const preis36 = String(form.bundlePreis36?.value || '').trim();
            const once = String(form.bundleEinmalkosten?.value || '').trim();
            // Backward-Compat: altes Feld bundlePreis mit 24M bef√ºllen
            if (form.bundlePreis) form.bundlePreis.value = preis24;

            const existing = bundles.find(b => b.id === slotId);
            const createdAt = existing?.createdAt || new Date().toISOString();

            const data = {
                id: slotId,
                __fixedSlot: true,
                legacy: false,
                categoryKey: meta.categoryKey,
                categoryLabel: __getCategoryLabel(meta.categoryKey),
                active: !!form.bundleActive?.checked,

                titel: form.bundleTitel.value,
                tarifName: form.bundleTarifName.value,
                angebotspreis: preis24,
                preis24: preis24,
                preis36: preis36,
                einmalkosten: once,
                hasSim: (typeof form.bundleHasSim !== 'undefined') ? !!form.bundleHasSim.checked : true,
                optionOnlineSchutz: form.bundleOptionOnlineSchutz.checked,
                optionTV: form.bundleOptionTV.checked,
                optionCustom: form.bundleOptionCustom.value,
                images: imagesArray,
                shopLink: form.bundleShopLink.value,
                gutscheincode: form.bundleGutschein.value,
                rechnungsweg: form.bundleRechnungsweg.value,
                start: form.bundleStart.value,
                end: form.bundleEnd.value,
                createdAt: createdAt
            };

            const idx = bundles.findIndex(b => b.id === slotId);
            if (idx !== -1) {
                bundles[idx] = data;
                showMessage('Bundle-Slot aktualisiert!');
            } else {
                bundles.push(data);
                showMessage('Bundle-Slot gespeichert!');
            }

            saveData();

            // Form bleibt auf Slot, damit du schnell ueberschreiben kannst
            document.getElementById('bundle-submit-btn').textContent = 'Bundle Slot Speichern';
        };

        window.deleteBundle = (id) => {
            // Regel: NICHT loeschen, nur deaktivieren
            const idx = bundles.findIndex(b => b.id === id);
            if (idx === -1) return;
            bundles[idx].active = false;
            saveData();
            showMessage('Bundle wurde deaktiviert (nicht geloescht).');
        };

        window.toggleBundleActive = (id) => {
            const idx = bundles.findIndex(b => b.id === id);
            if (idx === -1) return;
            bundles[idx].active = !bundles[idx].active;
            saveData();
            showMessage(bundles[idx].active ? 'Bundle aktiviert.' : 'Bundle deaktiviert.');
        };


        window.editBundle = (id) => {
            const data = bundles.find(b => b.id === id);
            if (!data) return;

            const form = document.getElementById('bundle-form');
            // Slot ist fix: beim Bearbeiten sperren wir die Auswahl.
            if (form.bundleSlot) {
                populateBundleSlotOptions();
                form.bundleSlot.value = id;
                form.bundleSlot.disabled = true;
            }
            if (form.bundleActive) form.bundleActive.checked = (typeof data.active === 'boolean') ? data.active : true;

            form.bundleTitel.value = data.titel || '';
            form.bundleTarifName.value = data.tarifName || '';
            if (form.bundlePreis24) form.bundlePreis24.value = (data.preis24 || data.angebotspreis || '');
            if (form.bundlePreis36) form.bundlePreis36.value = (data.preis36 || '');
            if (form.bundleEinmalkosten) form.bundleEinmalkosten.value = (data.einmalkosten || '');
            if (form.bundlePreis) form.bundlePreis.value = (data.preis24 || data.angebotspreis || '');
            form.bundleOptionOnlineSchutz.checked = !!data.optionOnlineSchutz;
            form.bundleOptionTV.checked = !!data.optionTV;
            if (form.bundleHasSim) form.bundleHasSim.checked = (typeof data.hasSim === 'boolean') ? data.hasSim : true;
            form.bundleOptionCustom.value = data.optionCustom || '';

            const container = document.getElementById('bundle-images-container');
            container.innerHTML = '';
            if (Array.isArray(data.images) && data.images.length > 0) {
                data.images.forEach(url => addBundleImageField(url));
            } else {
                addBundleImageField();
            }

            form.bundleShopLink.value = data.shopLink || '';
            form.bundleGutschein.value = data.gutscheincode || '';
            form.bundleRechnungsweg.value = data.rechnungsweg || '';
            form.bundleStart.value = data.start || '';
            form.bundleEnd.value = data.end || '';

            document.getElementById('bundle-submit-btn').textContent = 'Bundle Slot Speichern';
            document.getElementById('bundle-form').scrollIntoView({ behavior: 'smooth' });
        };

        window.copyToClipboard = (text) => {
            navigator.clipboard.writeText(text).then(() => {
                showMessage("Gutscheincode kopiert!");
            }, (err) => {
                console.error('Async: Could not copy text: ', err);
            });
        };

        // --- BUNDLE: Laufzeit-Auswahl (Kundenansicht) ---
        // Speichert die Auswahl pro Bundle und aktualisiert nur die Preis-Anzeige im jeweiligen Kasten.
        window.onBundleTermChange = (bundleId, term) => {
            try {
                const m = parseInt(term, 10);
                if (![24, 36].includes(m)) return;
                localStorage.setItem('bundle_term_' + bundleId, String(m));
                const priceEl = document.getElementById('bundle-price-' + bundleId);
                if (!priceEl) return;
                const card = priceEl.closest('[data-bundle-id]');
                if (!card) return;
                const p24 = (card.getAttribute('data-p24') || '').trim();
                const p36 = (card.getAttribute('data-p36') || '').trim();
                const newVal = (m === 36 ? (p36 || p24) : (p24 || p36)) || '';
                if (newVal) priceEl.textContent = newVal + ' ‚Ç¨';
            } catch (e) {
                console.warn('onBundleTermChange failed', e);
            }
        };


        // --- CRUD ACTIONS (PUSH PROVISION) ---
        window.savePushProvision = (event) => {
            event.preventDefault();
            const form = event.target;
            const betragValue = parseFloat(form.pushBetrag.value);
            if (isNaN(betragValue) || betragValue <= 0) {
                 showMessage("Bitte geben Sie einen g√ºltigen Betrag (> 0) ein.", true);
                 return;
            }
            const data = {
                id: form.dataset.editingId || generateId(),
                titel: form.pushTitel.value || 'Zusatz-Push', 
                betrag: betragValue, 
                start: form.pushStart.value,
                end: form.pushEnd.value,
                bemerkung: form.pushBemerkung.value,
                createdAt: form.dataset.editingId ? (pushProvisions.find(p => p.id === form.dataset.editingId)?.createdAt || new Date().toISOString()) : new Date().toISOString()
            };

            let changeLogEntry = null;
            if(!form.dataset.editingId) {
                changeLogEntry = `üí∞ Neuer PUSH: ${data.titel} (${data.betrag.toFixed(2)}‚Ç¨) ab ${data.start}`;
            } else {
                 const oldPush = pushProvisions.find(p => p.id === form.dataset.editingId);
                 if (oldPush && oldPush.betrag !== data.betrag) {
                     if (data.betrag > oldPush.betrag) {
                         changeLogEntry = `üí∞ PUSH ERH√ñHT: ${data.titel} jetzt ${data.betrag.toFixed(2)}‚Ç¨ (vorher ${oldPush.betrag.toFixed(2)}‚Ç¨)`;
                     } else {
                         changeLogEntry = `üìâ Push gesenkt: ${data.titel} auf ${data.betrag.toFixed(2)}‚Ç¨`;
                     }
                 }
            }

            if (form.dataset.editingId) {
                const index = pushProvisions.findIndex(p => p.id === form.dataset.editingId);
                if (index !== -1) pushProvisions[index] = data;
                showMessage("Push Provision aktualisiert!");
            } else {
                pushProvisions.push(data);
                showMessage("Push Provision gespeichert!");
            }

            if(changeLogEntry) addRecentChange(changeLogEntry);
            saveData();
            form.reset();
            delete form.dataset.editingId;
            document.getElementById('push-submit-btn').textContent = 'Push Speichern';
        };

        window.deletePushProvision = (id) => {
            if (!confirm('Wirklich l√∂schen?')) return;
            pushProvisions = pushProvisions.filter(p => p.id !== id);
            saveData();
            showMessage("Push gel√∂scht.");
        };

        window.editPushProvision = (id) => {
            const data = pushProvisions.find(p => p.id === id);
            if (!data) return;
            const form = document.getElementById('push-form');
            form.pushTitel.value = data.titel || ''; 
            form.pushBetrag.value = data.betrag || 0; 
            form.pushStart.value = data.start || '';
            form.pushEnd.value = data.end || '';
            form.pushBemerkung.value = data.bemerkung || '';
            form.dataset.editingId = id;
            document.getElementById('push-submit-btn').textContent = '√Ñnderungen Speichern';
            document.getElementById('push-form').scrollIntoView({ behavior: 'smooth' });
        };


        // --- CRUD ACTIONS (PROMOTIONS) ---

        window.savePromotion = (event) => {
            event.preventDefault();
            const form = event.target;
            let anbieterValue = form.anbieterSelect.value;
            if (anbieterValue === 'Freiertext') anbieterValue = form.anbieterFreiertext.value;
            if (!anbieterValue) { showMessage("Bitte geben Sie einen Anbieter ein.", true); return; }

            const data = {
                id: form.dataset.editingId || generateId(),
                anbieter: anbieterValue, 
                geraetebezeichnung: form.geraetebezeichnung.value,
                aktionsbeginn: form.aktionsbeginn.value,
                aktionsende: form.aktionsende.value,
                einkaufspreis: parseFloat(form.einkaufspreis.value) || 0,
                verkaufspreis: parseFloat(form.verkaufspreis.value) || 0,
                noEinkaufspreis: form.noEinkaufspreis.checked,
                noVerkaufspreis: form.noVerkaufspreis.checked,
                einmalzahlungXL: form.einmalzahlungXL.value,
                einmalzahlungL: form.einmalzahlungL.value,
                einmalzahlungM: form.einmalzahlungM.value,
                einmalzahlungS: form.einmalzahlungS.value,
                einmalzahlungHomeXL: form.einmalzahlungHomeXL.value,
                einmalzahlungHomeL: form.einmalzahlungHomeL.value,
                einmalzahlungHomeM: form.einmalzahlungHomeM.value,
                einmalzahlungHomeS: form.einmalzahlungHomeS.value,
                mobile: form.mobile.checked,
                myhome: form.myhome.checked,
                data: form.data.checked,
                anschlussbefreiung: form.anschlussbefreiung.checked,
                zusatzpush: form.zusatzpush.checked,
                sonderprovision: form.sonderprovision.value,
                bemerkung: form.bemerkung.value,
                bildUrl: form.bildUrl.value,
                hwBenefit24: form.hwBenefit24.value,
                hwBenefit36: form.hwBenefit36.value,
                createdAt: form.dataset.editingId ? (promotions.find(p => p.id === form.dataset.editingId)?.createdAt || new Date().toISOString()) : new Date().toISOString()
            };

            let changesLog = []; 
            if (form.dataset.editingId) {
                const oldData = promotions.find(p => p.id === form.dataset.editingId);
                if (oldData) {
                    const oldPrice = parseFloat(oldData.verkaufspreis);
                    const newPrice = parseFloat(data.verkaufspreis);
                    if (!data.noVerkaufspreis && !oldData.noVerkaufspreis) {
                        if (newPrice < oldPrice) changesLog.push(`üî• Preissturz: ${data.geraetebezeichnung} (${data.anbieter}) jetzt nur noch ${newPrice.toFixed(2)} ‚Ç¨!`);
                        else if (newPrice > oldPrice) changesLog.push(`üìà Preisanstieg: ${data.geraetebezeichnung} (${data.anbieter}) jetzt ${newPrice.toFixed(2)} ‚Ç¨.`);
                    } else if (!data.noVerkaufspreis && oldData.noVerkaufspreis) {
                        changesLog.push(`üî• Neu bepreist: ${data.geraetebezeichnung} (${data.anbieter}) jetzt f√ºr ${newPrice.toFixed(2)} ‚Ç¨!`);
                    }
                }
                const index = promotions.findIndex(p => p.id === form.dataset.editingId);
                if (index !== -1) promotions[index] = data;
                showMessage("Aktion lokal aktualisiert!");
            } else {
                promotions.push(data);
                const preisText = data.noVerkaufspreis ? 'Preis a.A.' : `${parseFloat(data.verkaufspreis).toFixed(2)} ‚Ç¨`;
                changesLog.push(`‚ú® Neu aufgenommen: ${data.geraetebezeichnung} (${data.anbieter}) f√ºr ${preisText}`);
                showMessage("Aktion lokal gespeichert!");
            }
            changesLog.forEach(log => addRecentChange(log));
            saveData();
            form.reset();
            delete form.dataset.editingId;
            document.getElementById('submit-btn').textContent = 'Aktion Speichern';
            toggleFreeText(null);
            togglePriceInput('EK', false);
            togglePriceInput('VK', false);
        };

        window.deletePromotion = (id) => {
            if (!confirm('Sind Sie sicher, dass Sie diese Aktion l√∂schen m√∂chten?')) return;
            promotions = promotions.filter(p => p.id !== id);
            saveData();
            showMessage("Aktion gel√∂scht.");
        };

        window.renewPromotion = (id) => {
            const index = promotions.findIndex(p => p.id === id);
            if (index === -1) return;
            const today = new Date();
            const renewalDate = new Date(today);
            renewalDate.setDate(renewalDate.getDate() + 30);
            const yyyy = renewalDate.getFullYear();
            const mm = String(renewalDate.getMonth() + 1).padStart(2, '0');
            const dd = String(renewalDate.getDate()).padStart(2, '0');
            promotions[index].aktionsende = `${yyyy}-${mm}-${dd}`;
            saveData();
            showMessage(`Verl√§ngert bis ${dd}.${mm}.${yyyy}!`);
        };

        window.editPromotion = (id) => {
            const data = promotions.find(p => p.id === id);
            if (!data) return;
            const form = document.getElementById('promotion-form');
            const provider = data.anbieter || '';
            if (predefinedProviders.includes(provider) && provider !== 'Freiertext') {
                form.anbieterSelect.value = provider;
                form.anbieterFreiertext.value = '';
                toggleFreeText(false);
            } else {
                form.anbieterSelect.value = 'Freiertext';
                form.anbieterFreiertext.value = provider;
                toggleFreeText(true);
            }
            form.geraetebezeichnung.value = data.geraetebezeichnung || '';
            form.aktionsbeginn.value = data.aktionsbeginn || '';
            form.aktionsende.value = data.aktionsende || '';
            form.einkaufspreis.value = data.einkaufspreis || 0;
            form.verkaufspreis.value = data.verkaufspreis || 0;
            form.noEinkaufspreis.checked = !!data.noEinkaufspreis;
            form.noVerkaufspreis.checked = !!data.noVerkaufspreis;
            togglePriceInput('EK', !!data.noEinkaufspreis);
            togglePriceInput('VK', !!data.noVerkaufspreis);
            form.einmalzahlungXL.value = data.einmalzahlungXL || '';
            form.einmalzahlungL.value = data.einmalzahlungL || '';
            form.einmalzahlungM.value = data.einmalzahlungM || '';
            form.einmalzahlungS.value = data.einmalzahlungS || '';
            form.einmalzahlungHomeXL.value = data.einmalzahlungHomeXL || '';
            form.einmalzahlungHomeL.value = data.einmalzahlungHomeL || '';
            form.einmalzahlungHomeM.value = data.einmalzahlungHomeM || '';
            form.einmalzahlungHomeS.value = data.einmalzahlungHomeS || '';
            form.mobile.checked = data.mobile || false;
            form.myhome.checked = data.myhome || false;
            form.data.checked = data.data || false;
            form.anschlussbefreiung.checked = data.anschlussbefreiung || false;
            form.zusatzpush.checked = data.zusatzpush || false;
            form.sonderprovision.value = data.sonderprovision || '';
            form.bemerkung.value = data.bemerkung || '';
            form.bildUrl.value = data.bildUrl || '';
            form.hwBenefit24.value = data.hwBenefit24 || '';
            form.hwBenefit36.value = data.hwBenefit36 || '';
            form.dataset.editingId = id;
            document.getElementById('submit-btn').textContent = '√Ñnderungen Speichern';
            window.scrollTo({ top: 0, behavior: 'smooth' });
        };

        // --- CRUD ACTIONS (INCENTIVES) ---
        window.saveIncentive = (event) => {
            event.preventDefault();
            const form = event.target;
            const data = {
                id: form.dataset.editingId || generateId(),
                titel: form.incentiveTitel.value,
                incentiveStart: form.incentiveStart.value,
                incentiveEnd: form.incentiveEnd.value,
                bildUrl: form.incentiveBildUrl.value,
                bemerkung: form.incentiveBemerkung.value,
                priority: 1, 
                createdAt: form.dataset.editingId ? (incentives.find(i => i.id === form.dataset.editingId)?.createdAt || new Date().toISOString()) : new Date().toISOString()
            };
            if(!form.dataset.editingId) addRecentChange(`‚≠ê Neues Incentive: ${data.titel}`);
            if (form.dataset.editingId) {
                const index = incentives.findIndex(i => i.id === form.dataset.editingId);
                if (index !== -1) incentives[index] = data;
                showMessage("Incentive aktualisiert!");
            } else {
                incentives.push(data);
                showMessage("Incentive gespeichert!");
            }
            saveData();
            form.reset();
            delete form.dataset.editingId;
            document.getElementById('incentive-submit-btn').textContent = 'Incentive Speichern';
        };

        window.deleteIncentive = (id) => {
            if (!confirm('L√∂schen?')) return;
            incentives = incentives.filter(i => i.id !== id);
            saveData();
            showMessage("Incentive gel√∂scht.");
        };

        window.editIncentive = (id) => {
            const data = incentives.find(i => i.id === id);
            if (!data) return;
            const form = document.getElementById('incentive-form');
            form.incentiveTitel.value = data.titel || '';
            form.incentiveStart.value = data.incentiveStart || '';
            form.incentiveEnd.value = data.incentiveEnd || '';
            form.incentiveBildUrl.value = data.bildUrl || '';
            form.incentiveBemerkung.value = data.bemerkung || '';
            form.dataset.editingId = id;
            document.getElementById('incentive-submit-btn').textContent = '√Ñnderungen Speichern';
            document.getElementById('incentive-form').scrollIntoView({ behavior: 'smooth' });
        };

        window.renewIncentive = (id) => {
            const index = incentives.findIndex(i => i.id === id);
            if (index === -1) return;
            const today = new Date();
            const renewalDate = new Date(today);
            renewalDate.setDate(renewalDate.getDate() + 30);
            const yyyy = renewalDate.getFullYear();
            const mm = String(renewalDate.getMonth() + 1).padStart(2, '0');
            const dd = String(renewalDate.getDate()).padStart(2, '0');
            incentives[index].incentiveEnd = `${yyyy}-${mm}-${dd}`;
            saveData();
            showMessage(`Incentive verl√§ngert bis ${dd}.${mm}.${yyyy}!`);
        };

        // --- RENDERING ---
        
        function renderAdminPushList(list) {
            const listEl = document.getElementById('admin-push-list');
            if (list.length === 0) {
                updateAdminTabCount('admin-tab-count-push', 0);
                listEl.innerHTML = '<p class="text-center text-gray-400">Keine Push-Provisionen vorhanden.</p>'; return; }
            listEl.innerHTML = list.map(p => {
                const expired = isExpired(p.end);
                const betragDisplay = p.betrag > 0 ? `${p.betrag.toFixed(2)} ‚Ç¨` : 'Betrag n.A.';
                return `
                    <div class="bg-white p-4 rounded-lg shadow-md flex justify-between items-center mb-3 border-l-4 ${expired ? 'border-red-500' : 'border-green-500'}">
                        <div>
                            <p class="text-lg font-semibold text-gray-800">Push: ${p.titel || 'Extra'} (${betragDisplay}) ${expired ? '<span class="text-red-500 text-xs font-bold">(ABGELAUFEN)</span>' : ''}</p>
                            <p class="text-xs text-gray-400">Zeitraum: ${p.start} bis ${p.end}</p>
                        </div>
                        <div class="flex space-x-2 admin-controls">
                            <button onclick='editPushProvision("${p.id}")' class="p-2 text-sm bg-yellow-500 text-white rounded-full hover:bg-yellow-600">Bearbeiten</button>
                            <button onclick='deletePushProvision("${p.id}")' class="p-2 text-sm bg-red-500 text-white rounded-full hover:bg-red-600">L√∂schen</button>
                        </div>
                    </div>
                `;
            }).join('');
            updateAdminTabCount('admin-tab-count-push', list.length);
        }

        function renderAdminBundleList(list) {
            const listEl = document.getElementById('admin-bundle-list');
            const fixed = sortBundlesForUI((list || []).filter(b => !b.legacy));
            const legacyCount = (list || []).filter(b => b.legacy).length;

            const legacyHint = legacyCount > 0
                ? `<div class="bg-yellow-50 border border-yellow-200 text-yellow-900 p-3 rounded-lg text-sm mb-4">‚ö†Ô∏è Hinweis: ${legacyCount} alte Bundle-Eintraege (Legacy) sind automatisch deaktiviert und werden nicht mehr genutzt.</div>`
                : '';

            if (fixed.length === 0) {
                listEl.innerHTML = legacyHint + '<p class="text-center text-gray-400">Keine Bundle-Slots vorhanden.</p>';
                updateAdminTabCount('admin-tab-count-bundle', 0);
                return;
            }

            listEl.innerHTML = legacyHint + fixed.map(b => {
                const expired = isExpired(b.end);
                const statusPill = b.active
                    ? `<span class="text-xs bg-green-100 text-green-800 px-2 py-1 rounded-full border border-green-200 font-bold">AKTIV</span>`
                    : `<span class="text-xs bg-gray-100 text-gray-700 px-2 py-1 rounded-full border border-gray-200 font-bold">INAKTIV</span>`;

                const cat = b.categoryLabel || __getCategoryLabel(b.categoryKey);

                return `
                    <div class="bg-white p-4 rounded-lg shadow-md flex justify-between items-center mb-3 border-l-4 ${expired ? 'border-red-500' : 'border-blue-800'}">
                        <div>
                            <div class="flex items-center gap-2 flex-wrap">
                                <p class="text-lg font-bold text-blue-900">üì¶ ${b.titel || '(leer)'} ${expired ? '<span class="text-red-500 text-xs font-bold">(ABGELAUFEN)</span>' : ''}</p>
                                ${statusPill}
                                <span class="text-xs bg-blue-50 text-blue-800 px-2 py-1 rounded border border-blue-100">${cat}</span>
                                <span class="text-xs bg-gray-50 text-gray-700 px-2 py-1 rounded border border-gray-100">ID: ${b.id}</span>
                            </div>
                            <p class="text-sm font-semibold text-gray-700">Tarif: ${b.tarifName || '-'} | Preis: ${b.angebotspreis || '-'} ‚Ç¨</p>
                            <p class="text-xs text-gray-400">Zeitraum: ${b.start || '-'} bis ${b.end || '-'}</p>
                        </div>
                        <div class="flex space-x-2 admin-controls items-center">
                            <button onclick='copyBundleLink("${b.id}")' class="p-2 text-sm bg-blue-100 text-blue-700 rounded-full hover:bg-blue-200 border border-blue-200 flex items-center gap-1 font-semibold transition" title="Direktlink kopieren">üîó Link</button>
                            <button onclick='editBundle("${b.id}")' class="p-2 text-sm bg-yellow-500 text-white rounded-full hover:bg-yellow-600">Bearbeiten</button>
                            <button onclick='toggleBundleActive("${b.id}")' class="p-2 text-sm ${b.active ? 'bg-gray-700 hover:bg-gray-800' : 'bg-green-600 hover:bg-green-700'} text-white rounded-full">${b.active ? 'Deaktivieren' : 'Aktivieren'}</button>
                        </div>
                    </div>
                `;
            }).join('');
            updateAdminTabCount('admin-tab-count-bundle', fixed.length);
        }

        function renderAdminPromotionList(list) {
            const listEl = document.getElementById('admin-promotion-list');
            if (list.length === 0) {
                updateAdminTabCount('admin-tab-count-promotions', 0);
                listEl.innerHTML = '<p class="text-center text-gray-400">Keine Aktionen gefunden.</p>'; return; }
            listEl.innerHTML = list.map(p => {
                const marge = calculateMargin(p.einkaufspreis, p.verkaufspreis, p.noEinkaufspreis, p.noVerkaufspreis);
                const expired = isExpired(p.aktionsende); 
                const einmalzahlungen = [
                    p.einmalzahlungXL ? `XL: ${p.einmalzahlungXL}` : null,
                    p.einmalzahlungL ? `L: ${p.einmalzahlungL}` : null,
                    p.einmalzahlungM ? `M: ${p.einmalzahlungM}` : null,
                    p.einmalzahlungS ? `S: ${p.einmalzahlungS}` : null
                ].filter(Boolean).join(' | ');

                let borderColor = 'border-gray-300';
                if (expired) borderColor = 'border-red-500';
                else if (marge === null) borderColor = 'border-blue-300'; 
                else if (parseFloat(marge) >= 0) borderColor = 'border-green-500';
                else borderColor = 'border-red-500';

                const margeDisplay = marge !== null 
                    ? `<span class="${parseFloat(marge) >= 0 ? 'text-green-600' : 'text-red-600'} font-bold">${marge} ‚Ç¨</span>` 
                    : '<span class="text-gray-400">n.v.</span>';

                const ekDisplay = p.noEinkaufspreis ? 'n.v.' : parseFloat(p.einkaufspreis).toFixed(2) + '‚Ç¨';
                const vkDisplay = p.noVerkaufspreis ? 'n.v.' : parseFloat(p.verkaufspreis).toFixed(2) + '‚Ç¨';

                return `
                    <div class="bg-white p-4 rounded-lg shadow-md flex justify-between items-center mb-3 border-l-4 ${borderColor}">
                        <div>
                            <p class="text-lg font-semibold text-gray-800">${p.geraetebezeichnung} (${p.anbieter}) ${expired ? '<span class="text-red-500 text-xs font-bold">(ABGELAUFEN)</span>' : ''}</p>
                            <p class="text-sm text-gray-500">EK: ${ekDisplay} | VK: ${vkDisplay} | Marge (Netto): ${margeDisplay}</p>
                            ${einmalzahlungen ? `<p class="text-xs text-gray-400">EZ Mobile: ${einmalzahlungen}</p>` : ''}
                            <p class="text-xs text-gray-400">${p.aktionsbeginn} bis ${p.aktionsende}</p>
                        </div>
                        <div class="flex space-x-2 admin-controls">
                            ${expired 
                                ? `<button onclick='renewPromotion("${p.id}")' class="p-2 text-sm bg-purple-600 text-white rounded-full hover:bg-purple-700 transition duration-150">30 Tage Verl√§ngern</button>`
                                : `<button onclick='editPromotion("${p.id}")' class="p-2 text-sm bg-yellow-500 text-white rounded-full hover:bg-yellow-600 transition duration-150">Bearbeiten</button>`
                            }
                            <button onclick='deletePromotion("${p.id}")' class="p-2 text-sm bg-red-500 text-white rounded-full hover:bg-red-600 transition duration-150">L√∂schen</button>
                        </div>
                    </div>
                `;
            }).join('');
            updateAdminTabCount('admin-tab-count-promotions', list.length);
        }

        function renderAdminIncentiveList(list) {
            const listEl = document.getElementById('admin-incentive-list');
            if (list.length === 0) {
                updateAdminTabCount('admin-tab-count-incentives', 0);
                listEl.innerHTML = '<p class="text-center text-gray-400">Keine Incentives vorhanden.</p>'; return; }
            listEl.innerHTML = list.map(p => {
                const expired = isExpired(p.incentiveEnd);
                return `
                    <div class="bg-white p-4 rounded-lg shadow-md flex justify-between items-center mb-3 border-l-4 ${expired ? 'border-red-500' : 'border-blue-500'}">
                        <div>
                            <p class="text-lg font-semibold text-gray-800">${p.titel || 'Incentive'} ${expired ? '<span class="text-red-500 text-xs font-bold">(ABGELAUFEN)</span>' : ''}</p>
                            <p class="text-sm text-gray-600 mb-1">${p.bemerkung.substring(0, 50)}${p.bemerkung.length > 50 ? '...' : ''}</p>
                            <p class="text-xs text-gray-400">Laufzeit: ${p.incentiveStart} bis ${p.incentiveEnd}</p>
                        </div>
                        <div class="flex space-x-2 admin-controls">
                            ${expired 
                                ? `<button onclick='renewIncentive("${p.id}")' class="p-2 text-sm bg-purple-600 text-white rounded-full hover:bg-purple-700 transition duration-150">30 Tage Verl√§ngern</button>`
                                : `<button onclick='editIncentive("${p.id}")' class="p-2 text-sm bg-yellow-500 text-white rounded-full hover:bg-yellow-600 transition duration-150">Bearbeiten</button>`
                            }
                            <button onclick='deleteIncentive("${p.id}")' class="p-2 text-sm bg-red-500 text-white rounded-full hover:bg-red-600 transition duration-150">L√∂schen</button>
                        </div>
                    </div>
                `;
            }).join('');
        }

        // Updated function signature to accept isSingleMode flag
        function renderUserView(promotionsList, incentivesList, pushList, bundlesList, isSingleMode = false) {
            const tocContainerEl = document.getElementById('toc-container');
            const viewEl = document.getElementById('user-view-content'); 
            const incentiveListEl = document.getElementById('user-incentive-list');
            const pushListEl = document.getElementById('user-push-list'); 
            const bundleListEl = document.getElementById('user-bundle-list');
            const bundleSectionHeader = document.getElementById('bundle-section-header');
            
            // --- Push Provisions ---
            const activePush = pushList.filter(p => !isExpired(p.end));
            if (activePush.length > 0) {
                pushListEl.innerHTML = activePush.map(p => {
                    const betragDisplay = p.betrag > 0 ? `${p.betrag.toFixed(2)} ‚Ç¨` : 'N.A.';
                    return `
                        <div class="break-inside-avoid print-break-avoid bg-white rounded-lg shadow-xl p-4 border-l-8 border-green-500 flex items-start space-x-4 hover:shadow-2xl transition duration-300">
                            <img src="https://placehold.co/100x100/22c55e/ffffff?text=%E2%82%AC" 
                                 alt="Euro Zeichen" class="w-20 h-20 object-contain rounded-md shadow flex-shrink-0">
                            <div class="flex-grow">
                                <h4 class="text-xl font-bold text-green-700">üí∞ PUSH: ${p.titel || 'Extra'} (${betragDisplay})</h4>
                                <p class="text-lg text-gray-800 font-semibold max-h-full">${p.bemerkung}</p>
                                <span class="text-xs text-gray-500 mt-2 block">G√ºltig: ${p.start} - ${p.end}</span>
                            </div>
                        </div>
                    `;
                }).join('');
                pushListEl.parentElement.classList.remove('hidden'); 
            } else {
                pushListEl.innerHTML = '';
                pushListEl.parentElement.classList.add('hidden'); 
            }

            // --- Incentives ---
            const activeIncentives = incentivesList.filter(p => !isExpired(p.incentiveEnd));
            if (activeIncentives.length > 0) {
                incentiveListEl.innerHTML = activeIncentives.map(i => `
                    <div class="break-inside-avoid print-break-avoid bg-white rounded-lg shadow-xl p-4 border-l-4 border-purple-500 flex items-start space-x-4 hover:shadow-2xl transition duration-300">
                        <img src="${i.bildUrl || 'https://placehold.co/80x80/8b5cf6/ffffff?text=Incentive'}" 
                             onerror="this.onerror=null;this.src='https://placehold.co/80x80/8b5cf6/ffffff?text=Incentive';" 
                             alt="Incentive Bild" class="w-20 h-20 object-contain bg-white border border-gray-100 rounded-md shadow flex-shrink-0">
                        <div class="flex-grow">
                            <h4 class="text-lg font-bold text-purple-700">‚≠ê ${i.titel || 'Incentive'}</h4>
                            <p class="text-sm text-gray-700 max-h-full">${i.bemerkung}</p>
                            <span class="text-xs text-gray-400 mt-1 block">Aktion: ${i.incentiveStart} - ${i.incentiveEnd}</span>
                        </div>
                    </div>
                `).join('');
            } else {
                incentiveListEl.innerHTML = '<p class="text-center text-gray-500 italic mt-4 col-span-full">Keine aktuellen Incentives.</p>';
            }

            // --- BUNDLES (NEU) ---
            // Fix: Use isSingleMode flag instead of checking length === 1
            const activeBundles = isSingleMode ? bundlesList : bundlesList.filter(b => (b.active === true) && !b.legacy && !isExpired(b.end));
            
            if (activeBundles.length > 0) {
                bundleListEl.innerHTML = activeBundles.map(b => {
                    // Bilder: nicht als super-breite Reihe, sondern als Kachel-Grid (wrapt automatisch)
                    // -> wirkt wie bei "Kunden Aktionen" sauber und bleibt kompakt.
                    const rawImages = Array.isArray(b.images) ? b.images.filter(Boolean) : [];
                    const includeSim = (typeof b.hasSim === 'boolean') ? b.hasSim : true;
                    const effectiveImages = includeSim ? rawImages.concat([FIXED_SIM_IMAGE_DATAURI]) : rawImages;
                    const imagesHtml = (effectiveImages && effectiveImages.length > 0)
                        ? `<div class="grid grid-cols-2 sm:grid-cols-3 gap-3 mb-4">
                            ${effectiveImages.map(img => `
                                <div class="bg-white border border-gray-100 rounded-lg shadow-sm p-2">
                                    <img src="${img}" class="${img.startsWith('data:image/svg+xml') ? 'sim-image' : ''}" class="w-full h-40 object-contain" onerror="this.style.display='none'">
                                </div>
                            `).join('')}
                          </div>`
                        : '';
                    
                    const badges = [
                        b.optionOnlineSchutz ? `<span class="px-2 py-1 bg-green-100 text-green-800 rounded-md text-xs font-bold border border-green-200">üõ°Ô∏è Inkl. Online Schutz</span>` : '',
                        b.optionTV ? `<span class="px-2 py-1 bg-blue-100 text-blue-800 rounded-md text-xs font-bold border border-blue-200">üì∫ Inkl. o2 TV</span>` : '',
                        b.optionCustom ? `<span class="px-2 py-1 bg-purple-100 text-purple-800 rounded-md text-xs font-bold border border-purple-200">‚ûï ${b.optionCustom}</span>` : ''
                    ].filter(Boolean).join('');

                    return `
                        <div class="break-inside-avoid print-break-avoid bg-white rounded-xl shadow-2xl overflow-hidden border-2 border-blue-800 transform hover:scale-[1.01] transition duration-300 h-full">
                            <div class="bg-blue-900 p-4 text-white">
                                <div class="flex items-center gap-2 min-w-0">
                                    <h3 class="bundle-card-title font-bold flex items-center gap-2 flex-1 min-w-0">
                                        <span class="flex-shrink-0">üì¶</span>
                                        <span class="bundle-title-text">${b.titel}</span>
                                    </h3>
                                </div>
                                <div class="mt-2">
                                    <span class="text-xs bg-blue-700 px-2 py-1 rounded inline-block">G√ºltig bis: ${b.end}</span>
                                </div>
                            </div>
                            <div class="p-6 relative">
                                <div class="flex flex-col md:flex-row justify-between items-start mb-4">
                                    <div class="mb-4 md:mb-0">
                                        <h4 class="text-xl font-bold text-gray-800 mb-1">${b.tarifName || 'Tarif nicht angegeben'}</h4>
                                        <div class="flex gap-2 flex-wrap mt-2">${badges}</div>
                                    </div>
                                    ${(() => {
                                        const p24 = String(b.preis24 ?? b.preis_24 ?? b.preis24m ?? b.angebotspreis ?? '').trim();
                                        const p36 = String(b.preis36 ?? b.preis_36 ?? b.preis36m ?? '').trim();
                                        const once = String(b.einmalkosten ?? b.einmal ?? '').trim();
                                        const opts = [];
                                        if (p24) opts.push({m:24, v:p24});
                                        if (p36) opts.push({m:36, v:p36});
                                        if (!opts.length) return '';
                                        const key = 'bundle_term_' + b.id;
                                        let sel = parseInt(localStorage.getItem(key) || '0', 10);
                                        if (!opts.some(o => o.m === sel)) sel = opts[0].m;
                                        const dv = (opts.find(o => o.m === sel) || opts[0]).v;
                                        const selectHtml = (opts.length > 1)
                                            ? `<select class="bundle-term-select" aria-label="Laufzeit" onchange="window.onBundleTermChange && window.onBundleTermChange('${b.id}', this.value)">${opts.map(o => `<option value="${o.m}" ${o.m===sel?'selected':''}>${o.m} Monate</option>`).join('')}</select>`
                                            : `<span class="text-xs bg-blue-700 px-2 py-1 rounded font-bold">${opts[0].m} Monate</span>`;
                                        const onceHtml = once ? `<div class="bundle-onetime">Einmalig: ${once} ‚Ç¨</div>` : '';
                                        return `
                                            <div class="bg-red-600 text-white px-4 py-2 rounded-md shadow-md" data-bundle-id="${b.id}" data-p24="${p24}" data-p36="${p36}">
                                                <div class="flex items-center justify-center gap-2 mb-1">${selectHtml}</div>
                                                <span class="block text-xs uppercase font-bold text-red-100 text-center">Angebotspreis</span>
                                                <span id="bundle-price-${b.id}" class="block text-2xl font-extrabold text-center">${dv} ‚Ç¨</span>
                                                ${onceHtml}
                                            </div>
                                        `;
                                    })()}
                                </div>

                                ${imagesHtml}
                                
                                <div class="bg-blue-50 p-4 rounded-lg border-l-4 border-blue-600 mb-4 mt-4">
                                    <h4 class="font-bold text-blue-900 mb-2">Rechnungsweg / Buchungsprozess:</h4>
                                    <div class="text-gray-800 text-sm whitespace-pre-line">${b.rechnungsweg}</div>
                                </div>
                                
                                ${b.shopLink ? `
                                <div class="mt-4 text-center">
                                    <a href="${b.shopLink}" target="_blank" class="inline-block bg-green-600 text-white font-bold text-lg px-8 py-3 rounded-full shadow-lg hover:bg-green-700 hover:scale-105 transition transform flex items-center justify-center gap-2">
                                        üëâ Zum Angebot
                                    </a>
                                </div>
                                ` : ''}

                                ${b.gutscheincode ? `
                                <div class="flex items-center gap-4 mt-4 pt-4 border-t border-gray-200">
                                    <span class="text-sm font-bold text-gray-600">Gutscheincode:</span>
                                    <code class="bg-gray-100 text-red-600 font-mono text-lg px-3 py-1 rounded border border-gray-300 cursor-pointer hover:bg-yellow-100 select-all" title="Klicken zum Kopieren" onclick="copyToClipboard('${b.gutscheincode}')">${b.gutscheincode}</code>
                                    <span class="text-xs text-gray-400">(Klicken zum Kopieren)</span>
                                </div>
                                ` : ''}
                            </div>
                        </div>
                    `;
                }).join('');
                if(bundleSectionHeader) bundleSectionHeader.classList.remove('hidden');
                bundleListEl.classList.remove('hidden');
            } else {
                bundleListEl.innerHTML = '';
                if(bundleSectionHeader) bundleSectionHeader.classList.add('hidden');
                bundleListEl.classList.add('hidden');
            }


            // --- Promotions ---
            const activePromotions = promotionsList.filter(p => !isExpired(p.aktionsende));
            
            // Fix: Check isSingleMode flag instead of length logic
            if (isSingleMode) {
                 // Do not render promotions in single view mode
                 viewEl.innerHTML = '';
                 tocContainerEl.innerHTML = '';
                 return;
            }

            if (activePromotions.length === 0) {
                viewEl.innerHTML = '<p class="text-center text-gray-500 mt-10 text-xl">Aktuell sind keine Ger√§te-Aktionen verf√ºgbar.</p>';
                tocContainerEl.innerHTML = ''; 
                return;
            }

            const groupedPromotions = activePromotions.reduce((acc, p) => {
                const anbieter = p.anbieter || 'Unbekannter Anbieter';
                if (!acc[anbieter]) acc[anbieter] = [];
                acc[anbieter].push(p);
                return acc;
            }, {});

            const anbieterList = Object.keys(groupedPromotions).sort();

            let tocHtml = '';
            
            // NEU: BUNDLE LINK IN TOC (WENN AKTIV und nicht Single View)
            if (activeBundles.length > 0) {
                tocHtml += `
                <a href="#bundle-section-header" class="block p-3 bg-blue-100 hover:bg-blue-200 rounded-lg text-blue-900 font-bold border-2 border-blue-300 transition duration-150 shadow-sm hover:shadow-md text-center">
                    üì¶ o2 Bundle Angebote (${activeBundles.length})
                </a>`;
            }

            tocHtml += anbieterList.map(anbieter => {
                const safeId = anbieter.replace(/[^a-zA-Z0-9]/g, '_');
                return `<a href="#${safeId}" class="block p-3 bg-blue-50 hover:bg-blue-100 rounded-lg text-blue-700 font-medium transition duration-150 shadow-sm hover:shadow-md text-center">${anbieter} (${groupedPromotions[anbieter].length})</a>`;
            }).join('');
            
            // Inhaltsverzeichnis (TOC)
            tocContainerEl.innerHTML = `
                <div class="bg-white p-6 rounded-xl shadow-lg mb-8 break-inside-avoid print-break-avoid">
                    <h3 class="text-xl font-bold text-gray-800 mb-4">Inhaltsangabe: Anbieter-√úbersicht</h3>
                    <div class="grid grid-cols-2 sm:grid-cols-3 lg:grid-cols-4 gap-4">
                        ${tocHtml}
                    </div>
                </div>
            `;

            let groupedPromotionsHtml = '';
            anbieterList.forEach(anbieter => {
                const safeId = anbieter.replace(/[^a-zA-Z0-9]/g, '_');
                groupedPromotionsHtml += `
                    <div id="${safeId}" class="mt-10 pt-4 border-t-2 border-blue-600 break-after-avoid print-break-avoid">
                        <h3 class="text-3xl font-extrabold text-blue-800 mb-6">${anbieter} Aktionen</h3>
                    </div>
                    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-8 mb-12">
                `;
                
                groupedPromotions[anbieter].forEach((p, index) => {
                    const marge = calculateMargin(p.einkaufspreis, p.verkaufspreis, p.noEinkaufspreis, p.noVerkaufspreis);
                    const tariffs = [ p.mobile ? 'Mobilfunk-Tarife' : '', p.myhome ? 'Festnetz-Tarife' : '', p.data ? 'Datentarife' : '' ].filter(Boolean);
                    const hasHomeEz = p.einmalzahlungHomeXL || p.einmalzahlungHomeL || p.einmalzahlungHomeM || p.einmalzahlungHomeS;
                    const pageBreakClass = (index > 0 && (index + 1) % 3 === 0 && index !== (groupedPromotions[anbieter].length - 1)) ? 'page-break-after-3' : '';

                    groupedPromotionsHtml += `
                        <div class="break-inside-avoid print-break-avoid bg-white rounded-xl shadow-2xl overflow-hidden hover:shadow-3xl transform hover:-translate-y-1 transition duration-300 ${pageBreakClass}">
                            <div class="relative h-48 bg-white flex items-center justify-center p-4">
                                <img src="${p.bildUrl || 'https://placehold.co/400x200/2563eb/ffffff?text=Bild+Fehlt'}" 
                                     onerror="this.onerror=null;this.src='https://placehold.co/400x200/2563eb/ffffff?text=Bild+Fehlt';" 
                                     alt="${p.geraetebezeichnung}" class="w-full h-full object-contain">
                                ${!p.noVerkaufspreis ? `<div class="absolute top-3 right-3 bg-red-600 text-white text-xs font-bold py-1 px-3 rounded-full shadow-lg">Verkaufspreis: ${parseFloat(p.verkaufspreis).toFixed(2)} ‚Ç¨</div>` : ''}
                            </div>
                            <div class="p-5">
                                <h2 class="text-2xl font-extrabold text-gray-900 mb-1">${p.geraetebezeichnung}</h2>
                                <p class="text-sm font-medium text-blue-600 mb-3">${p.anbieter}</p>
                                <div class="flex items-center text-sm text-gray-500 mb-4"><span>Aktion: ${p.aktionsbeginn} - ${p.aktionsende}</span></div>
                                <div class="flex flex-wrap gap-2 mb-4">${tariffs.map(t => `<span class="px-3 py-1 text-xs font-semibold text-blue-800 bg-blue-100 rounded-full">${t}</span>`).join('')}</div>
                                <div class="space-y-2 mb-4">
                                    ${p.anschlussbefreiung ? '<span class="flex items-center text-sm text-green-700 font-medium">‚úÖ Anschlussbefreiung</span>' : ''}
                                    ${p.zusatzpush ? '<span class="flex items-center text-sm text-purple-700 font-medium">‚ö° Zus√§tzlicher Push</span>' : ''}
                                    ${p.sonderprovision ? `<span class="flex items-center text-sm text-yellow-700 font-medium">üí∞ Sonderprovision: ${p.sonderprovision}</span>` : ''}
                                </div>
                                <div class="mt-4 space-y-2 border-t pt-4">
                                    <p class="text-xs font-semibold text-gray-700">Hardware Benefits:</p>
                                    ${p.hwBenefit24 ? `<a href="${p.hwBenefit24}" target="_blank" class="block text-sm text-blue-500 hover:text-blue-700 truncate">24 Monate Details</a>` : ''}
                                    ${p.hwBenefit36 ? `<a href="${p.hwBenefit36}" target="_blank" class="block text-sm text-blue-500 hover:text-blue-700 truncate">36 Monate Details</a>` : ''}
                                </div>
                                ${p.bemerkung ? `<div class="mt-4 p-3 bg-gray-50 rounded-lg text-sm text-gray-700 italic">${p.bemerkung}</div>` : ''}
                                <div class="mt-5 pt-3 border-t">
                                    <p class="text-xs font-semibold text-gray-700 mb-1">Einmalzahlung o2 Mobile (Kunde):</p>
                                    <div class="text-xs text-gray-500 grid grid-cols-2 gap-1">
                                        ${p.einmalzahlungXL ? `<span><span class="font-bold">XL:</span> ${p.einmalzahlungXL}</span>` : ''}
                                        ${p.einmalzahlungL ? `<span><span class="font-bold">L:</span> ${p.einmalzahlungL}</span>` : ''}
                                        ${p.einmalzahlungM ? `<span><span class="font-bold">M:</span> ${p.einmalzahlungM}</span>` : ''}
                                        ${p.einmalzahlungS ? `<span><span class="font-bold">S:</span> ${p.einmalzahlungS}</span>` : ''}
                                    </div>
                                    ${hasHomeEz ? `
                                        <p class="text-xs font-semibold text-gray-700 mb-1 mt-2">Einmalzahlung o2 My Home (Kunde):</p>
                                        <div class="text-xs text-gray-500 grid grid-cols-2 gap-1">
                                            ${p.einmalzahlungHomeXL ? `<span><span class="font-bold">XL:</span> ${p.einmalzahlungHomeXL}</span>` : ''}
                                            ${p.einmalzahlungHomeL ? `<span><span class="font-bold">L:</span> ${p.einmalzahlungHomeL}</span>` : ''}
                                            ${p.einmalzahlungHomeM ? `<span><span class="font-bold">M:</span> ${p.einmalzahlungHomeM}</span>` : ''}
                                            ${p.einmalzahlungHomeS ? `<span><span class="font-bold">S:</span> ${p.einmalzahlungHomeS}</span>` : ''}
                                        </div>
                                    ` : ''}
                                    <p class="text-xs text-gray-500 mt-2 pt-2 border-t">EK: ${p.noEinkaufspreis ? 'n.v.' : parseFloat(p.einkaufspreis).toFixed(2) + ' ‚Ç¨'}</p>
                                    <p class="text-md font-bold text-gray-800">Marge (Netto): ${marge !== null ? `<span class="${parseFloat(marge) >= 0 ? 'text-green-600' : 'text-red-600'}">${marge} ‚Ç¨</span>` : '<span class="text-gray-400">n.v.</span>'}</p>
                                </div>
                            </div>
                        </div>
                    `;
                }); 
                groupedPromotionsHtml += `</div>`;
            }); 
            viewEl.innerHTML = groupedPromotionsHtml;
        }

        window.switchView = () => {
            const isAdmin = document.getElementById('view-toggle').checked;
            document.getElementById('admin-view').classList.toggle('hidden', !isAdmin);
            document.getElementById('user-view').classList.toggle('hidden', isAdmin);
            document.getElementById('view-name').textContent = isAdmin ? 'Admin-Ansicht' : 'Kunden-Ansicht';
            
            // NEU: Update Button Logik
            const emailBtn = document.getElementById('email-update-btn');
            if(emailBtn) {
                if(isAdmin) emailBtn.classList.remove('hidden');
                else emailBtn.classList.add('hidden');
            }
            updateAdminTabCount('admin-tab-count-incentives', list.length);
        };

        window.toggleFreeText = (manualOverride) => {
            const selectEl = document.getElementById('anbieterSelect');
            const freitextContainer = document.getElementById('anbieter-freitext-container');
            let isFreeTextSelected;
            if (manualOverride !== null) { isFreeTextSelected = manualOverride; } else { isFreeTextSelected = selectEl.value === 'Freiertext'; }
            freitextContainer.classList.toggle('hidden', !isFreeTextSelected);
            const freitextInput = document.getElementById('anbieterFreiertext');
            if (isFreeTextSelected) { freitextInput.setAttribute('required', 'required'); } else { freitextInput.removeAttribute('required'); freitextInput.value = ''; }
        };

        // --- INIT ---

        // --- ADMIN TABS (UI-only) ---
        function setAdminTab(tabKey) {
            const btns = Array.from(document.querySelectorAll('.admin-tab-btn'));
            const panels = Array.from(document.querySelectorAll('.admin-tab-panel'));
            btns.forEach(b => {
                const active = b.getAttribute('data-tab') === tabKey;
                b.classList.toggle('is-active', active);
            });
            panels.forEach(p => {
                const active = p.getAttribute('data-tab-panel') === tabKey;
                p.classList.toggle('hidden', !active);
            });
            try { sessionStorage.setItem('ADMIN_ACTIVE_TAB', tabKey); } catch(e) {}
        }

        function updateAdminTabCount(id, value) {
            const el = document.getElementById(id);
            if (!el) return;
            const n = (typeof value === 'number') ? value : (Array.isArray(value) ? value.length : 0);
            el.textContent = String(n);
        }

        function initAdminTabs() {
            const btns = Array.from(document.querySelectorAll('.admin-tab-btn'));
            if (!btns.length) return;
            btns.forEach(btn => {
                btn.addEventListener('click', () => setAdminTab(btn.getAttribute('data-tab')));
            });
            let startTab = 'push';
            try {
                const saved = sessionStorage.getItem('ADMIN_ACTIVE_TAB');
                if (saved) startTab = saved;
            } catch(e) {}
            setAdminTab(startTab);
        }


        // Click-Delegation (failsafe): Tabs funktionieren auch wenn vorherige Funktionen Fehler werfen
        document.addEventListener('click', (e) => {
            const btn = e.target.closest('.admin-tab-btn');
            if (!btn) return;
            e.preventDefault();
            const key = btn.getAttribute('data-tab');
            if (!key) return;
            setAdminTab(key);
        }, true);


        document.addEventListener('DOMContentLoaded', () => {
            // Tabs sofort initialisieren (UI darf nicht von Cloud/Render-Fehlern blockiert werden)
            try { initAdminTabs(); } catch(e) {}

            // Restliche Initialisierung abgesichert (damit ein Fehler nicht die komplette UI lahmlegt)
            try { loadData(); } catch(e) { console.warn('loadData error', e); }
            try { trackAndDisplayVisits(); } catch(e) { console.warn('trackAndDisplayVisits error', e); }
            try { switchView(); } catch(e) { console.warn('switchView error', e); }
            try { toggleFreeText(false); } catch(e) {}
            // Initialize one empty image field for bundle form
            try { addBundleImageField(); } catch(e) {}
            try { populateBundleSlotOptions(); } catch(e) {}

            
            const today = new Date();
            const dateStr = today.toLocaleDateString('de-DE', { day: '2-digit', month: '2-digit', year: 'numeric' });
            const printTitleEl = document.getElementById('print-header-title');
            if(printTitleEl) { printTitleEl.textContent = `Aktionsmappe ${dateStr}`; }
            const einkaufEl = document.getElementById('einkaufspreis');
            const verkaufEl = document.getElementById('verkaufspreis');
            const margePreviewEl = document.getElementById('marge-preview');
            const updateMarginPreview = () => {
                if (einkaufEl.disabled || verkaufEl.disabled) {
                    margePreviewEl.textContent = 'Marge: -';
                    margePreviewEl.className = 'text-gray-400 font-semibold text-lg';
                    return;
                }
                const marge = calculateMargin(einkaufEl.value, verkaufEl.value, false, false);
                margePreviewEl.textContent = `Vorschau Marge (Netto): ${marge} ‚Ç¨`;
                margePreviewEl.className = `font-semibold ${parseFloat(marge) >= 0 ? 'text-green-600' : 'text-red-600'}`;
            };
            einkaufEl.addEventListener('input', updateMarginPreview);
            verkaufEl.addEventListener('input', updateMarginPreview);
            updateMarginPreview(); 

            window.addEventListener('storage', (e) => {
                if ([STORAGE_KEY_PROMOTIONS, STORAGE_KEY_INCENTIVES, STORAGE_KEY_VISITS, STORAGE_KEY_PUSH, STORAGE_KEY_BUNDLES, STORAGE_KEY_PDF].includes(e.key)) {
                    // Debounce + Local-only reload (kein Cloud-Load, kein Zurueckschreiben in localStorage)
                    window.__lsReloadT && clearTimeout(window.__lsReloadT);
                    window.__lsReloadT = setTimeout(() => reloadFromLocalStorageOnly(), 150);
                }
            });
            const currencyInputs = ['einmalzahlungXL', 'einmalzahlungL', 'einmalzahlungM', 'einmalzahlungS', 'einmalzahlungHomeXL', 'einmalzahlungHomeL', 'einmalzahlungHomeM', 'einmalzahlungHomeS', 'sonderprovision'];
            currencyInputs.forEach(id => {
                const el = document.getElementById(id);
                if (el) { el.addEventListener('blur', () => formatCurrencyInput(el)); }
            });
        });
    </script>
</head>
<body class="min-h-screen">
    <div class="max-w-7xl mx-auto p-4 sm:p-6 lg:p-8">
        
        <!-- Header und View Switch -->
        <header class="bg-white shadow-xl rounded-xl p-5 mb-8 flex flex-col md:flex-row justify-between items-center sticky top-0 z-10 no-print-shadow">
            
            <!-- LOGO UND TITEL CONTAINER -->
            <div class="flex items-center header-content mb-4 md:mb-0">
                <!-- HeTec GmbH LOGO -->
                <div class="hetec-logo text-blue-700 font-extrabold text-xl mr-4 tracking-wider">
                    HeTec GmbH
                </div>
                
                <!-- NEU: DYNAMISCHER TITEL F√úR DRUCK -->
                <h1 class="text-3xl font-extrabold text-gray-900">
                    <span class="screen-only-text">Aktionsmappen-Dashboard</span>
                    <span id="print-header-title" class="print-only-text">Aktionsmappe</span>
                    <span class="text-sm font-normal text-gray-500 screen-only-text">(Lokal)</span>
                </h1>
            </div>

            <div class="flex items-center space-x-6">
                <!-- PDF / DRUCKEN BUTTON -->
                <button onclick="exportToPdf()" class="flex items-center space-x-2 bg-gray-800 hover:bg-gray-900 text-white px-4 py-2 rounded-lg transition shadow">
                    <span>üñ®Ô∏è PDF / Drucken</span>
                </button>

                <!-- NEU: EMAIL UPDATE BUTTON (Jetzt Standardm√§√üig hidden) -->
                <button id="email-update-btn" onclick="sendUpdateEmail()" class="hidden relative flex items-center space-x-2 bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg transition shadow">
                    <span>‚úâÔ∏è Update-Mail senden</span>
                    <!-- Badge f√ºr Anzahl der √Ñnderungen -->
                    <span id="email-badge" class="absolute -top-2 -right-2 bg-red-500 text-white text-xs font-bold px-2 py-1 rounded-full hidden">0</span>
                </button>

                <div class="flex items-center space-x-3">
                    <label id="view-name" class="text-lg font-medium text-gray-700" for="view-toggle">Kunden-Ansicht</label>
                    <label for="view-toggle" class="relative inline-block w-14 h-8 cursor-pointer toggle-switch">
                        <input type="checkbox" id="view-toggle" class="opacity-0 w-0 h-0" onchange="switchView()">
                        <span class="slider absolute cursor-pointer top-0 left-0 right-0 bottom-0 bg-gray-300 rounded-full transition duration-400 before:absolute before:content-[''] before:h-6 before:w-6 before:left-1 before:bottom-1 before:bg-white before:rounded-full before:transition before:duration-400"></span>
                    </label>
                </div>
            </div>
        </header>

        <!-- Statusmeldung -->
        <div id="status-message" class="hidden text-center"></div>

        <!-- 1. ADMIN-ANSICHT -->
        <section id="admin-view" class="space-y-8">
            <h2 class="text-2xl font-bold text-gray-800 border-b pb-2">Admin-Bereich: Verwaltung (Lokal)</h2>
            
            <!-- Besuchsz√§hler Anzeige -->
            <div id="visit-counter-display" class="text-lg font-bold text-gray-600 p-3 bg-yellow-50 rounded-lg shadow-sm">
                Besuche diesen Monat: Lade...
            </div>
            
            
            <!-- ADMIN: Eingaben (oben) -->
            <div class="pt-2">
                <h2 class="text-2xl font-bold text-gray-800 mb-4">Eingaben / Pflege</h2>
                <div class="space-y-8">
<!-- PUSH PROVISION VERWALTUNG (NEU GANZ OBEN) -->
            <div class="space-y-6 pt-2 pb-6 border-b-2 border-green-300 bg-green-50 rounded-lg p-4">
                <h3 class="text-xl font-bold text-green-700 flex items-center">
                    üí∞ Push Provision Verwaltung
                </h3>
                <div class="bg-white p-6 rounded-xl shadow-lg border border-green-200">
                    <form id="push-form" onsubmit="savePushProvision(event)" data-editing-id="">
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <!-- NEU: Titel / Bezeichnung -->
                            <div class="md:col-span-2">
                                <label for="pushTitel" class="block text-sm font-medium text-gray-700">Titel / Bezeichnung der Provision</label>
                                <input type="text" id="pushTitel" name="pushTitel" placeholder="z.B. Black Friday Push" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-2 border" required>
                            </div>
                            
                            <!-- NEU: Betrag -->
                            <div>
                                <label for="pushBetrag" class="block text-sm font-medium text-gray-700">Betrag (‚Ç¨, numerisch)</label>
                                <input type="number" step="0.01" id="pushBetrag" name="pushBetrag" placeholder="z.B. 30.00" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-2 border" required>
                            </div>

                            <!-- Start / Ende -->
                            <div>
                                <label for="pushStart" class="block text-sm font-medium text-gray-700">Push Start</label>
                                <input type="date" id="pushStart" name="pushStart" required class="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-2 border">
                            </div>
                            <div>
                                <label for="pushEnd" class="block text-sm font-medium text-gray-700">Push Ende</label>
                                <input type="date" id="pushEnd" name="pushEnd" required class="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-2 border">
                            </div>
                            
                            <!-- Bemerkungsfeld -->
                            <div class="md:col-span-2">
                                <label for="pushBemerkung" class="block text-sm font-medium text-gray-700">Bemerkung (Was gibt es extra?)</label>
                                <textarea id="pushBemerkung" name="pushBemerkung" rows="2" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-2 border" required></textarea>
                            </div>

                        </div>
                        <div class="mt-6">
                            <button id="push-submit-btn" type="submit" class="w-full py-3 px-4 border border-transparent rounded-lg shadow-lg text-lg font-medium text-white bg-green-600 hover:bg-green-700 focus:outline-none transition duration-150">
                                Push Speichern
                            </button>
                        </div>
                    </form>
                </div>
            </div>

<!-- BUNDLE VERWALTUNG (NEU) -->
            <div class="space-y-6 pt-6 border-b-2 border-blue-900 bg-blue-50 rounded-lg p-4">
                <h3 class="text-xl font-bold text-blue-900 flex items-center">
                    üì¶ o2 Bundle Angebote Verwaltung
                </h3>
                <div class="bg-white p-6 rounded-xl shadow-lg border border-blue-200">
                    <form id="bundle-form" onsubmit="saveBundle(event)" data-editing-id="">
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <!-- SLOT AUSWAHL (FIXED) -->
                            <div class="md:col-span-2">
                                <label for="bundleSlot" class="block text-sm font-medium text-gray-700">Canvas / Slot (fester Link)</label>
                                <select id="bundleSlot" name="bundleSlot" required class="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-2 border"></select>
                                <p class="text-xs text-gray-500 mt-1">Diese Slot-ID bleibt immer gleich (Link bleibt stabil). Loeschen ist deaktiviert - nur aktiv/deaktiv.</p>
                            </div>

                            <!-- Aktiv / Deaktiv -->
                            <div class="md:col-span-2">
                                <label class="flex items-center gap-2 cursor-pointer bg-gray-50 p-3 rounded-lg border border-gray-200 hover:bg-gray-100 transition">
                                    <input type="checkbox" id="bundleActive" name="bundleActive" class="h-4 w-4 text-blue-600 rounded" checked>
                                    <span class="text-sm font-semibold text-gray-800">üü¢ Angebot aktiv (wird beworben)</span>
                                </label>
                            </div>

                            <!-- Titel -->
                            <div class="md:col-span-2">
                                <label for="bundleTitel" class="block text-sm font-medium text-gray-700">Bundle Bezeichnung / Titel</label>
                                <input type="text" id="bundleTitel" name="bundleTitel" placeholder="z.B. o2 Mobile M + iPhone 16 Pro + TV" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-2 border" required>
                            </div>
                            
                            <!-- NEU: Tarif Name & Angebotspreis -->
                            <div>
                                <label for="bundleTarifName" class="block text-sm font-medium text-gray-700">Tarif Name (z.B. o2 Mobile M)</label>
                                <input type="text" id="bundleTarifName" name="bundleTarifName" placeholder="o2 Mobile M" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-2 border">
                            </div>
                            <div class="md:col-span-2">
                                <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                                    <div>
                                        <label for="bundlePreis24" class="block text-sm font-medium text-gray-700">Preis 24 Monate (‚Ç¨/Monat)</label>
                                        <input type="text" id="bundlePreis24" name="bundlePreis24" placeholder="z.B. 49,99" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-2 border font-bold text-blue-900">
                                    </div>
                                    <div>
                                        <label for="bundlePreis36" class="block text-sm font-medium text-gray-700">Preis 36 Monate (‚Ç¨/Monat)</label>
                                        <input type="text" id="bundlePreis36" name="bundlePreis36" placeholder="z.B. 44,99" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-2 border font-bold text-blue-900">
                                    </div>
                                    <div>
                                        <label for="bundleEinmalkosten" class="block text-sm font-medium text-gray-700">Einmalkosten (einmalig ‚Ç¨)</label>
                                        <input type="text" id="bundleEinmalkosten" name="bundleEinmalkosten" placeholder="z.B. 0,00" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-2 border">
                                    </div>
                                </div>
                                <input type="hidden" id="bundlePreis" name="bundlePreis" value="">
                                <p class="text-xs text-gray-500 mt-1">Wenn 24 & 36 gesetzt sind, sieht der Kunde im Bundle ein Laufzeit-Dropdown und der Preis wechselt.</p>
                            </div>

                            <!-- NEU: Optionen -->
                            <div class="md:col-span-2 space-y-2 mt-2 p-3 bg-blue-50 rounded-lg border border-blue-100">
                                <label class="block text-sm font-medium text-gray-700 mb-1">Enthaltene Optionen (Badge-Anzeige):</label>
                                <div class="flex flex-wrap gap-4 items-center">
                                    <label class="flex items-center space-x-2 cursor-pointer bg-white p-2 rounded border hover:bg-gray-50 transition">
                                        <input type="checkbox" id="bundleOptionOnlineSchutz" name="bundleOptionOnlineSchutz" class="h-4 w-4 text-blue-600 rounded">
                                        <span class="text-sm font-medium">üõ°Ô∏è Inkl. Online Schutz</span>
                                    </label>
                                    <label class="flex items-center space-x-2 cursor-pointer bg-white p-2 rounded border hover:bg-gray-50 transition">
                                        <input type="checkbox" id="bundleOptionTV" name="bundleOptionTV" class="h-4 w-4 text-blue-600 rounded">
                                        <span class="text-sm font-medium">üì∫ Inkl. o2 TV</span>
                                    </label>
                                    <label class="flex items-center space-x-2 cursor-pointer bg-white p-2 rounded border hover:bg-gray-50 transition">
                                        <input type="checkbox" id="bundleHasSim" name="bundleHasSim" class="h-4 w-4 text-blue-600 rounded" checked>
                                        <span class="text-sm font-medium">üí≥ SIM-Karte enthalten (SIM-Bild automatisch)</span>
                                    </label>
                                    <div class="flex-grow">
                                        <input type="text" id="bundleOptionCustom" name="bundleOptionCustom" placeholder="Weitere Option (z.B. Netflix, Napster...)" class="block w-full text-sm rounded-md border-gray-300 shadow-sm p-2 border">
                                    </div>
                                </div>
                            </div>

                            <!-- Bilder -->
                            <div class="md:col-span-2">
                                <label class="block text-sm font-medium text-gray-700 mb-2">Bild-URLs</label>
                                <div id="bundle-images-container" class="space-y-2 mb-2">
                                    <!-- Hier werden die Input Felder dynamisch eingef√ºgt -->
                                </div>
                                <button type="button" onclick="addBundleImageField()" class="text-sm bg-blue-100 text-blue-700 px-3 py-1 rounded hover:bg-blue-200 transition font-medium">
                                    + Weiteres Bild hinzuf√ºgen
                                </button>
                            </div>

                            <!-- NEU: Shop Link -->
                            <div class="md:col-span-2">
                                <label for="bundleShopLink" class="block text-sm font-medium text-gray-700">Externer Link / Shop-Link (Optional)</label>
                                <input type="url" id="bundleShopLink" name="bundleShopLink" placeholder="https://mein-shop.de/angebot-xyz" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-2 border">
                                <p class="text-xs text-gray-500 mt-1">Wenn ausgef√ºllt, erscheint ein "Zum Angebot" Button beim Kunden.</p>
                            </div>

                            <!-- Gutschein -->
                            <div>
                                <label for="bundleGutschein" class="block text-sm font-medium text-gray-700">Gutscheincode</label>
                                <input type="text" id="bundleGutschein" name="bundleGutschein" placeholder="z.B. SOMMER25" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-2 border">
                            </div>

                            <!-- Rechnungsweg / Erkl√§rung -->
                            <div class="md:col-span-2">
                                <label for="bundleRechnungsweg" class="block text-sm font-medium text-gray-700">Rechnungsweg & Buchungsprozess (Erkl√§rung)</label>
                                <textarea id="bundleRechnungsweg" name="bundleRechnungsweg" rows="4" placeholder="Buchungsprozess: Einzahlung 100‚Ç¨ in Kasse..." class="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-2 border" required></textarea>
                            </div>

                            <!-- Start / Ende -->
                            <div>
                                <label for="bundleStart" class="block text-sm font-medium text-gray-700">Startdatum</label>
                                <input type="date" id="bundleStart" name="bundleStart" required class="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-2 border">
                            </div>
                            <div>
                                <label for="bundleEnd" class="block text-sm font-medium text-gray-700">Enddatum</label>
                                <input type="date" id="bundleEnd" name="bundleEnd" required class="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-2 border">
                            </div>
                        </div>
                        <div class="mt-6">
                            <button id="bundle-submit-btn" type="submit" class="w-full py-3 px-4 border border-transparent rounded-lg shadow-lg text-lg font-medium text-white bg-blue-800 hover:bg-blue-900 focus:outline-none transition duration-150">
                                Bundle Speichern
                            </button>
                        </div>
                    </form>
                </div>
            </div>

<!-- PROMOTIONS VERWALTUNG (Jetzt oben) -->
            <h3 class="text-xl font-bold text-blue-600 pt-6 border-t border-gray-300">Ger√§te-Aktionseingabe</h3>

            <!-- Eingabeformular -->
            <div class="bg-white p-6 rounded-xl shadow-lg">
                <form id="promotion-form" onsubmit="savePromotion(event)" data-editing-id="">
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                        
                        <!-- 1. Allgemeine Daten -->
                        <div class="col-span-3 border-b pb-4 mb-4">
                            <h3 class="text-xl font-semibold text-blue-600 mb-3">Basisdaten</h3>
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                
                                <!-- Anbieter Dropdown -->
                                <div>
                                    <label for="anbieterSelect" class="block text-sm font-medium text-gray-700">Anbieter (Auswahl)</label>
                                    <select id="anbieterSelect" name="anbieterSelect" required onchange="toggleFreeText(null)" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-2 border bg-white">
                                        <option value="" disabled selected>W√§hlen Sie einen Anbieter...</option>
                                        <option value="o2">o2</option>
                                        <option value="HeTec">HeTec</option>
                                        <option value="GreenMnky">GreenMnky</option>
                                        <option value="Freiertext">Andere / Freier Text</option>
                                    </select>
                                </div>

                                <!-- Freitextfeld (optional) -->
                                <div id="anbieter-freitext-container" class="hidden">
                                    <label for="anbieterFreiertext" class="block text-sm font-medium text-gray-700">Anbieter (Freier Text)</label>
                                    <input type="text" id="anbieterFreiertext" name="anbieterFreiertext" placeholder="Geben Sie den Anbieternamen ein" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-2 border">
                                </div>
                                
                                <div>
                                    <label for="geraetebezeichnung" class="block text-sm font-medium text-gray-700">Ger√§tebezeichnung</label>
                                    <input type="text" id="geraetebezeichnung" name="geraetebezeichnung" required class="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-2 border">
                                </div>
                                <div>
                                    <label for="aktionsbeginn" class="block text-sm font-medium text-gray-700">Aktionsbeginn</label>
                                    <input type="date" id="aktionsbeginn" name="aktionsbeginn" required class="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-2 border">
                                </div>
                                <div>
                                    <label for="aktionsende" class="block text-sm font-medium text-gray-700">Aktionsende</label>
                                    <input type="date" id="aktionsende" name="aktionsende" required class="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-2 border">
                                </div>
                            </div>
                        </div>

                        <!-- 2. Preis- und Margendaten -->
                        <div class="col-span-3 border-b pb-4 mb-4">
                            <h3 class="text-xl font-semibold text-blue-600 mb-3">Preise & Marge</h3>
                            <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                                
                                <!-- EINKAUFSPREIS MIT CHECKBOX -->
                                <div>
                                    <label for="einkaufspreis" class="block text-sm font-medium text-gray-700">Einkaufspreis (‚Ç¨)</label>
                                    <div class="mt-1 flex items-center gap-2">
                                        <input type="number" step="0.01" id="einkaufspreis" name="einkaufspreis" required class="block w-full rounded-md border-gray-300 shadow-sm p-2 border">
                                        <div class="flex flex-col items-center">
                                            <input type="checkbox" id="noEinkaufspreis" name="noEinkaufspreis" onchange="togglePriceInput('EK', this.checked)" class="h-4 w-4 text-blue-600 border-gray-300 rounded">
                                            <label for="noEinkaufspreis" class="text-[10px] text-gray-500">n.v.</label>
                                        </div>
                                    </div>
                                </div>

                                <!-- VERKAUFSPREIS MIT CHECKBOX -->
                                <div>
                                    <label for="verkaufspreis" class="block text-sm font-medium text-gray-700">Verkaufspreis (‚Ç¨)</label>
                                    <div class="mt-1 flex items-center gap-2">
                                        <input type="number" step="0.01" id="verkaufspreis" name="verkaufspreis" required class="block w-full rounded-md border-gray-300 shadow-sm p-2 border">
                                        <div class="flex flex-col items-center">
                                            <input type="checkbox" id="noVerkaufspreis" name="noVerkaufspreis" onchange="togglePriceInput('VK', this.checked)" class="h-4 w-4 text-blue-600 border-gray-300 rounded">
                                            <label for="noVerkaufspreis" class="text-[10px] text-gray-500">n.v.</label>
                                        </div>
                                    </div>
                                </div>

                                <div class="flex items-end">
                                    <p id="marge-preview" class="font-semibold text-lg"></p>
                                </div>
                            </div>
                            
                            <!-- Strukturierte Einmalzahlung Mobile -->
                            <div class="mt-4 col-span-3">
                                <label class="block text-sm font-medium text-gray-700 mb-2">Einmalzahlung (o2 Mobile XL/L/M/S)</label>
                                <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
                                    <div>
                                        <label for="einmalzahlungXL" class="block text-xs font-medium text-gray-500">XL (‚Ç¨)</label>
                                        <input type="text" id="einmalzahlungXL" name="einmalzahlungXL" placeholder="z.B. 1‚Ç¨" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-2 border text-sm">
                                    </div>
                                    <div>
                                        <label for="einmalzahlungL" class="block text-xs font-medium text-gray-500">L (‚Ç¨)</label>
                                        <input type="text" id="einmalzahlungL" name="einmalzahlungL" placeholder="z.B. 29,99‚Ç¨" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-2 border text-sm">
                                    </div>
                                    <div>
                                        <label for="einmalzahlungM" class="block text-xs font-medium text-gray-500">M (‚Ç¨)</label>
                                        <input type="text" id="einmalzahlungM" name="einmalzahlungM" placeholder="z.B. 49,99‚Ç¨" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-2 border text-sm">
                                    </div>
                                    <div>
                                        <label for="einmalzahlungS" class="block text-xs font-medium text-gray-500">S (‚Ç¨)</label>
                                        <input type="text" id="einmalzahlungS" name="einmalzahlungS" placeholder="z.B. 99,99‚Ç¨" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-2 border text-sm">
                                    </div>
                                </div>
                            </div>

                            <!-- Strukturierte Einmalzahlung Home -->
                            <div class="mt-4 col-span-3">
                                <label class="block text-sm font-medium text-gray-700 mb-2">Einmalzahlung (o2 My Home XL/L/M/S)</label>
                                <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
                                    <div>
                                        <label for="einmalzahlungHomeXL" class="block text-xs font-medium text-gray-500">Home XL (‚Ç¨)</label>
                                        <input type="text" id="einmalzahlungHomeXL" name="einmalzahlungHomeXL" placeholder="z.B. 1‚Ç¨" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-2 border text-sm">
                                    </div>
                                    <div>
                                        <label for="einmalzahlungHomeL" class="block text-xs font-medium text-gray-500">Home L (‚Ç¨)</label>
                                        <input type="text" id="einmalzahlungHomeL" name="einmalzahlungHomeL" placeholder="z.b. 29,99‚Ç¨" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-2 border text-sm">
                                    </div>
                                    <div>
                                        <label for="einmalzahlungHomeM" class="block text-xs font-medium text-gray-500">Home M (‚Ç¨)</label>
                                        <input type="text" id="einmalzahlungHomeM" name="einmalzahlungHomeM" placeholder="z.B. 49,99‚Ç¨" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-2 border text-sm">
                                    </div>
                                    <div>
                                        <label for="einmalzahlungHomeS" class="block text-xs font-medium text-gray-500">Home S (‚Ç¨)</label>
                                        <input type="text" id="einmalzahlungHomeS" name="einmalzahlungHomeS" placeholder="z.B. 99,99‚Ç¨" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-2 border text-sm">
                                    </div>
                                </div>
                            </div>

                        </div>

                        <!-- 3. Tarif-G√ºltigkeit -->
                        <div class="col-span-3 border-b pb-4 mb-4">
                            <h3 class="text-xl font-semibold text-blue-600 mb-3">Tarif-G√ºltigkeit</h3>
                            <div class="flex flex-wrap gap-6">
                                <div class="flex items-center">
                                    <input id="mobile" name="mobile" type="checkbox" class="h-4 w-4 text-blue-600 border-gray-300 rounded">
                                    <label for="mobile" class="ml-2 block text-sm text-gray-700">o2 Mobile (XL/L/M/S)</label>
                                </div>
                                <div class="flex items-center">
                                    <input id="myhome" name="myhome" type="checkbox" class="h-4 w-4 text-blue-600 border-gray-300 rounded">
                                    <label for="myhome" class="ml-2 block text-sm text-gray-700">o2 My Home (XL/L/M/S)</label>
                                </div>
                                <div class="flex items-center">
                                    <input id="data" name="data" type="checkbox" class="h-4 w-4 text-blue-600 border-gray-300 rounded">
                                    <label for="data" class="ml-2 block text-sm text-gray-700">o2 Data (XL/L/M)</label>
                                </div>
                            </div>
                        </div>

                        <!-- 4. Sonstiges -->
                        <div class="col-span-3 border-b pb-4 mb-4">
                            <h3 class="text-xl font-semibold text-blue-600 mb-3">Zus√§tzliche Infos</h3>
                            <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                                <div class="flex items-center">
                                    <input id="anschlussbefreiung" name="anschlussbefreiung" type="checkbox" class="h-4 w-4 text-pink-600 border-gray-300 rounded">
                                    <label for="anschlussbefreiung" class="ml-2 block text-sm text-gray-700">Anschlusspreisbefreiung</label>
                                </div>
                                <div class="flex items-center">
                                    <input id="zusatzpush" name="zusatzpush" type="checkbox" class="h-4 w-4 text-pink-600 border-gray-300 rounded">
                                    <label for="zusatzpush" class="ml-2 block text-sm text-gray-700">Zus√§tzlichen Push</label>
                                </div>
                                <div>
                                    <label for="sonderprovision" class="block text-sm font-medium text-gray-700">Sonderprovision</label>
                                    <input type="text" id="sonderprovision" name="sonderprovision" placeholder="z.B. +50‚Ç¨" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-2 border">
                                </div>
                            </div>
                            <div class="mt-4">
                                <label for="bemerkung" class="block text-sm font-medium text-gray-700">Bemerkungsfeld</label>
                                <textarea id="bemerkung" name="bemerkung" rows="3" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-2 border"></textarea>
                            </div>
                        </div>
                        
                        <!-- 5. Bild und Links -->
                        <div class="col-span-3">
                            <h3 class="text-xl font-semibold text-blue-600 mb-3">Bilder & Benefits (URLs)</h3>
                            <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                                <div>
                                    <label for="bildUrl" class="block text-sm font-medium text-gray-700">Bild URL (Ger√§t)</label>
                                    <input type="url" id="bildUrl" name="bildUrl" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-2 border">
                                </div>
                                <div>
                                    <label for="hwBenefit24" class="block text-sm font-medium text-gray-700">HW Benefit 24 Monate (Link)</label>
                                    <input type="url" id="hwBenefit24" name="hwBenefit24" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-2 border">
                                </div>
                                <div>
                                    <label for="hwBenefit36" class="block text-sm font-medium text-gray-700">HW Benefit 36 Monate (Link)</label>
                                    <input type="url" id="hwBenefit36" name="hwBenefit36" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-2 border">
                                </div>
                            </div>
                        </div>
                        
                    </div>
                    
                    <!-- Speichern Button -->
                    <div class="mt-8">
                        <button id="submit-btn" type="submit" class="w-full py-3 px-4 border border-transparent rounded-lg shadow-lg text-lg font-medium text-white bg-blue-700 hover:bg-blue-800 focus:outline-none transition duration-150">
                            Aktion Speichern
                        </button>
                    </div>
                </form>
            </div>

            
<!-- PDF Upload Section -->
            <div id="pdf-upload-section" class="mt-12 pt-6 border-t-2 border-gray-300">
                <h3 class="text-xl font-bold text-gray-800 mb-4">PDF Aktions√ºbersicht verwalten</h3>
                <div class="bg-white p-6 rounded-xl shadow-lg flex items-center justify-between">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Aktuelle o2 √úbersicht hochladen (PDF)</label>
                        <input type="file" id="pdf-upload-input" accept="application/pdf" class="block w-full text-sm text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-blue-50 file:text-blue-700 hover:file:bg-blue-100" onchange="handlePdfUpload(event)">
                        <p id="pdf-status-label" class="text-xs text-gray-500 mt-2">Kein PDF ausgew√§hlt</p>
                    </div>
                    <button onclick="deletePdf()" class="bg-red-500 text-white px-4 py-2 rounded-lg text-sm hover:bg-red-600">PDF L√∂schen</button>
                </div>
                <!-- Admin Vorschau -->
                <div id="admin-pdf-preview" class="mt-6"></div>
            </div>
            
            
<!-- DATEN BACKUP SECTION (NEU) -->
            <div id="data-backup-section" class="mt-12 pt-6 border-t-2 border-gray-300">
                <h3 class="text-xl font-bold text-yellow-600 mb-4">üíæ Daten-Backup & Wiederherstellung</h3>
                <div class="bg-white p-6 rounded-xl shadow-lg space-y-4">
                    <!-- Export -->
                    <div class="flex justify-between items-center">
                        <p class="text-sm text-gray-700">Sichern Sie alle eingegebenen Aktionen als JSON-Datei.</p>
                        <button onclick="exportData()" class="bg-yellow-500 text-white px-4 py-2 rounded-lg text-sm font-semibold hover:bg-yellow-600 transition">
                            Daten exportieren (JSON)
                        </button>
                    </div>
                    
                    <!-- Import -->
                    <div class="border-t pt-4 flex flex-col sm:flex-row justify-between items-start sm:items-center space-y-3 sm:space-y-0">
                        <label class="block text-sm font-medium text-gray-700">Daten wiederherstellen (Import)</label>
                        <input type="file" id="import-input" accept="application/json" class="block w-full sm:w-auto text-sm text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-gray-100 file:text-gray-700 hover:file:bg-gray-200" onchange="importData(event)">
                    </div>
                </div>
            </div>


            
<!-- INCENTIVES VERWALTUNG (Jetzt unten) -->
            <div class="space-y-6 pt-10 border-t-2 border-gray-300 mt-12">
                <h3 class="text-xl font-bold text-purple-700">Incentive Verwaltung</h3>
                <div class="bg-white p-6 rounded-xl shadow-lg">
                    <form id="incentive-form" onsubmit="saveIncentive(event)" data-editing-id="">
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <!-- Titel (NEU) -->
                            <div class="md:col-span-2">
                                <label for="incentiveTitel" class="block text-sm font-medium text-gray-700">Titel / Bezeichnung</label>
                                <input type="text" id="incentiveTitel" name="incentiveTitel" placeholder="z.B. Xiaomi Watch Aktion" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-2 border" required>
                            </div>

                            <!-- Start / Ende -->
                            <div>
                                <label for="incentiveStart" class="block text-sm font-medium text-gray-700">Incentive Start</label>
                                <input type="date" id="incentiveStart" name="incentiveStart" required class="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-2 border">
                            </div>
                            <div>
                                <label for="incentiveEnd" class="block text-sm font-medium text-gray-700">Incentive Ende</label>
                                <input type="date" id="incentiveEnd" name="incentiveEnd" required class="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-2 border">
                            </div>
                            
                            <!-- Bild Link (Prio entfernt) -->
                            <div class="md:col-span-2">
                                <label for="incentiveBildUrl" class="block text-sm font-medium text-gray-700">Bild URL</label>
                                <input type="url" id="incentiveBildUrl" name="incentiveBildUrl" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-2 border">
                            </div>
                            
                            <!-- Bemerkungsfeld -->
                            <div class="md:col-span-2">
                                <label for="incentiveBemerkung" class="block text-sm font-medium text-gray-700">Bemerkung</label>
                                <textarea id="incentiveBemerkung" name="incentiveBemerkung" rows="2" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-2 border" required></textarea>
                            </div>

                        </div>
                        <div class="mt-6">
                            <button id="incentive-submit-btn" type="submit" class="w-full py-3 px-4 border border-transparent rounded-lg shadow-lg text-lg font-medium text-white bg-purple-700 hover:bg-purple-800 focus:outline-none transition duration-150">
                                Incentive Speichern
                            </button>
                        </div>
                    </form>
                </div>
            </div>

                </div>
            </div>

            <!-- ADMIN: √úbersichten (unten) -->
            <div class="pt-2">
                <div class="flex flex-col md:flex-row md:items-end md:justify-between gap-4 mb-4">
                    <h2 class="text-2xl font-bold text-gray-800">√úbersichten</h2>

                    <!-- Tabs -->
                    <div class="w-full md:w-auto">
                        <div class="inline-flex flex-wrap items-center gap-2 bg-white border rounded-xl shadow-sm p-2">
                            <button type="button" class="admin-tab-btn px-3 py-2 rounded-lg text-sm font-semibold border transition" data-tab="push">
                                üí∞ Push <span id="admin-tab-count-push" class="ml-2 text-xs px-2 py-0.5 rounded-full bg-gray-100 border">0</span>
                            </button>
                            <button type="button" class="admin-tab-btn px-3 py-2 rounded-lg text-sm font-semibold border transition" data-tab="bundle">
                                üì¶ Bundles <span id="admin-tab-count-bundle" class="ml-2 text-xs px-2 py-0.5 rounded-full bg-gray-100 border">0</span>
                            </button>
                            <button type="button" class="admin-tab-btn px-3 py-2 rounded-lg text-sm font-semibold border transition" data-tab="promotions">
                                üìã Ger√§te <span id="admin-tab-count-promotions" class="ml-2 text-xs px-2 py-0.5 rounded-full bg-gray-100 border">0</span>
                            </button>
                            <button type="button" class="admin-tab-btn px-3 py-2 rounded-lg text-sm font-semibold border transition" data-tab="incentives">
                                ‚≠ê Incentives <span id="admin-tab-count-incentives" class="ml-2 text-xs px-2 py-0.5 rounded-full bg-gray-100 border">0</span>
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Panels -->
                <div class="space-y-6">

                    <div class="admin-tab-panel" data-tab-panel="push">
                        <div class="bg-white rounded-xl shadow-lg border p-4">
                            <div class="flex items-center justify-between mb-3">
                                <h3 class="text-lg font-bold text-green-700">üí∞ Push Provisionen</h3>
                            </div>
                            <div id="admin-push-list" class="space-y-4"><div class="text-center text-gray-500 p-4">Lade Push Provisionen...</div></div>
                        </div>
                    </div>

                    <div class="admin-tab-panel hidden" data-tab-panel="bundle">
                        <div class="bg-white rounded-xl shadow-lg border p-4">
                            <div class="flex items-center justify-between mb-3">
                                <h3 class="text-lg font-bold text-blue-900">üì¶ o2 Bundle Angebote</h3>
                            </div>
                            <div id="admin-bundle-list" class="space-y-4"><div class="text-center text-gray-500 p-4">Lade Bundles...</div></div>
                        </div>
                    </div>

                    <div class="admin-tab-panel hidden" data-tab-panel="promotions">
                        <div class="bg-white rounded-xl shadow-lg border p-4">
                            <div class="flex flex-col md:flex-row md:items-center md:justify-between gap-3 mb-3">
                                <h3 class="text-lg font-bold text-blue-700">üìã Ger√§te-Aktionen</h3>
                                <div id="admin-search-container" class="w-full md:w-96">
                                    <input type="text" id="admin-search" placeholder="Suche (Ger√§t, Anbieter...)" class="w-full p-2 border rounded shadow-sm focus:ring-2 focus:ring-blue-500 focus:outline-none" oninput="filterAdminPromotions()">
                                </div>
                            </div>
                            <div id="admin-promotion-list" class="space-y-4"><div class="text-center text-gray-500 p-4">Lade Aktionen...</div></div>
                        </div>
                    </div>

                    <div class="admin-tab-panel hidden" data-tab-panel="incentives">
                        <div class="bg-white rounded-xl shadow-lg border p-4">
                            <div class="flex items-center justify-between mb-3">
                                <h3 class="text-lg font-bold text-purple-700">‚≠ê Incentives</h3>
                            </div>
                            <div id="admin-incentive-list" class="space-y-4"><div class="text-center text-gray-500 p-4">Lade Incentives...</div></div>
                        </div>
                    </div>

                </div>
            </div>

</section>


        <!-- 2. BENUTZER-ANSICHT (Kundenansicht) -->
        <section id="user-view" class="hidden">
            <div class="flex flex-col md:flex-row justify-between items-center mb-6">
                <h2 class="text-3xl font-extrabold text-gray-900">Aktionen und Incentives</h2>
                <!-- NEU: Suchfeld -->
                <div id="user-search-container" class="mt-4 md:mt-0 w-full md:w-1/3">
                     <input type="text" id="user-search" placeholder="üîç Suche (Ger√§t, Tarif, Incentive)..." 
                            class="w-full p-3 border border-gray-300 rounded-full shadow-sm focus:ring-2 focus:ring-blue-500 focus:outline-none"
                            oninput="handleUserSearch()">
                </div>
            </div>
            
            <!-- PUSH PROVISION DISPLAY (NEU GANZ OBEN, GRID LAYOUT) -->
             <div class="mb-8 hidden">
                <h3 class="text-2xl font-bold text-green-700 mb-4 border-b pb-2">üí∞ Push Provisionen</h3>
                <div id="user-push-list" class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                    <!-- Wird per JS gef√ºllt -->
                </div>
            </div>

            <!-- Incentive-√úbersicht (Prio entfernt) -->
            <div class="mb-12">
                <h3 class="text-2xl font-bold text-purple-700 mb-4 border-b pb-2">‚≠ê Top Incentives</h3>
                <div id="user-incentive-list" class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                    <p class="text-center text-gray-500 p-4 col-span-full">Lade Incentives...</p>
                </div>
            </div>
            
            <!-- √úberschrift Ger√§te-Aktionen (Beginnt auf Seite 2) -->
            <!-- WICHTIG: Die ID "device-actions-header" sorgt f√ºr den Seitenumbruch im Druck -->
            <h3 id="device-actions-header" class="text-2xl font-bold text-blue-700 mb-6 border-b pb-2">Ger√§te-Aktionen</h3>
            
            <!-- Inhaltsangabe Promotions (Beginnt auf Seite 2) -->
            <div id="toc-container">
                <div class="text-center text-gray-500 p-4">Lade Inhaltsangabe...</div>
            </div>

            <!-- BUNDLES ANZEIGE (VERSCHOBEN NACH UNTEN) -->
            <div class="mb-12 hidden" id="bundle-section-header">
                <h3 class="text-2xl font-bold text-blue-900 mb-4 border-b pb-2">üì¶ o2 Bundle Angebote</h3>
                <!-- Grid wie bei den Aktionen: 3 Kacheln nebeneinander (Desktop) -->
                <div id="user-bundle-list" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-8">
                    <!-- Wird per JS gef√ºllt -->
                </div>
            </div>

            <!-- Gruppierter Inhalt (Promotions) (Beginnt auf Seite 3) -->
            <div id="user-view-content">
                <div class="text-center text-gray-500 p-4">Lade Aktionen...</div>
            </div>

            <!-- PDF Container User View -->
            <div id="user-pdf-container" class="mt-16">
                <!-- PDF wird hier gerendert -->
            </div>
        </section>

    </div>
</body>
</html>
